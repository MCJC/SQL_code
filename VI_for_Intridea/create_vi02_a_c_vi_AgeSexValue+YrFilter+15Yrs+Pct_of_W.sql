/* ++> create_vi02_a_c_vi_AgeSexValue+YrFilter+15Yrs+Pct_of_W.sql <++ */
--/***************************************************************************************************************************************************************/
--USE [forum]
--GO
--/***************************************************************************************************************************************************************/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
--/***************************************************************************************************************************************************************/
--ALTER  VIEW
--               [dbo].[vi_AgeSexValue_Pct_of_W]
--AS
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--SELECT
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--          [ASpwv_row]           = ROW_NUMBER()
--                                  OVER(ORDER BY
--                                        [Religion]
--                                      , [SubReligion]
--                                      , [year]
--                                      , [Sex_fk]
--                                      , [Age]
--                                      , [level]        DESC
--                                      , [Nation_fk]         )
--        , [Year]
--        , [level]
--        , [SubRegion6_code]
--        , [Nation_fk]
--        , [Region]
--        , [Country]
--        , [Religion_fk]
--        , [Religion]
--        , [SubReligion]
--        , [Sex]
--        , [Age]
--        , [Population]
--        , [Percentage_of_WP]
--        , [Data_source_fk]
--        , [NV_Display_AgeStr_15Yrs]
--        , [RV_Display_AgeStr_15Yrs]
--        , [Sex_fk]
--        , [Age_fk]
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--  FROM
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--                [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs_Pct_of_W]                                     -- drop table if existent
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--WHERE
--                [NV_Display_AgeStr_15Yrs]   = 1                                     --  ONLY data to be displayed by population
--AND
--      NOT (     [Religion_fk]              !=  52
--            AND [RV_Display_AgeStr_15Yrs]   =   0      )                            --  ONLY data to be displayed by religion
--AND
--                [Religion_fk]               IS NOT NULL                              --  exclude Christian sub-groups
--/***************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [forum]..[vi_AgeSexValue_Pct_of_W]                                                     <<<<<     ***/
/***             NOTE:  The view is based on a fixed table hosted at [forum_ResAnal]                                                                         ***/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the table [forum_ResAnal]..[vi_AgeSexValue_15Yrs_Pct_of_W]                                      <<<<<     ***/
/***             NOTE:  This is a fixed table hosted at the default place for auxiliary fixed tables: [forum_ResAnal]                                        ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/**** database name specification [forum_ResAnal] because it is the default place for auxiliary fixed tables) **************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
USE              [forum_ResAnal]
GO
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID (N'[forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs_Pct_of_W]', N'U') IS NOT NULL
DROP   TABLE    [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs_Pct_of_W]                                     -- drop table if existent
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
GO
/***************************************************************************************************************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          [ASpwv_row]           = ROW_NUMBER()
                                  OVER(ORDER BY
                                        RV.[Religion]
                                      , RV.[SubReligion]
                                      , RV.[year]
                                      , RV.[Sex_fk]
                                      , RV.[Age]
                                      , RV.[level]        DESC
                                      , RV.[Nation_fk]         )
        , RV.[Year]
        , RV.[level]
        , RV.[SubRegion6_code]
        , RV.[Nation_fk]
        , RV.[Region]
        , RV.[Country]
        , RV.[Religion_fk]
        , RV.[Religion]
        , RV.[SubReligion]
        , RV.[Sex]
        , RV.[Age]
        ,    [Population]       = CAST ( ROUND(RV.[Population], 0) AS DECIMAL (12,0) )
        ,    [Percentage_of_WP] = CAST ( ROUND(100 * (RV.[Population] / WV.[Population]), 1) AS DECIMAL ( 5,1) )
        , RV.[Data_source_fk]
        ,    [NV_Display_AgeStr_15Yrs] = RV.[NV_Display]
        ,    [RV_Display_AgeStr_15Yrs] = RV.[RV_Display]
        , RV.[Sex_fk]
        , RV.[Age_fk]
----------------------------------------------------------------------------------------------------------------------------
    INTO  [vi_AgeSexValue_15Yrs_Pct_of_W]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        (  SELECT *
             FROM [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          WHERE           [Sex_fk]       = 0
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          AND   NOT (     [Religion_fk] IS NULL
                      AND [Year]        != '2010'   )                                                                        --  150,697 (p)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          AND             [Year]        IN ( 2010, 2020, 2030, 2040, 2050 )                                     )     RV     --   68,239 (checked)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
LEFT JOIN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        (  SELECT [Year]
                 ,[Religion]
                 ,[SubReligion]
                 ,[Age]
                 ,[Population]
             FROM [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          WHERE           [Sex_fk]       = 0
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          AND   NOT (     [Religion_fk] IS NULL
                      AND [Year]        != '2010'   )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          AND             [Year]        IN ( 2010, 2020, 2030, 2040, 2050 )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          AND             [Nation_fk]    = 10000                                                                )     WV
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       ON  RV.[Year]        = WV.[Year]
      AND  RV.[Religion]    = WV.[Religion]
      AND  RV.[SubReligion] = WV.[SuBReligion]
      AND  RV.[Age]         = WV.[Age]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
GO