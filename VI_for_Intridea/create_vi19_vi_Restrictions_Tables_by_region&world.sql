/* ++> create_vi19_vi_Restrictions_Tables_by_region&world.sql <++ */
--/***************************************************************************************************************************************************************/
--USE [forum]
--GO
--/***************************************************************************************************************************************************************/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
--/***************************************************************************************************************************************************************/
--ALTER  VIEW
--              [dbo].[vi_Restrictions_Tables_by_region&world]
--AS
--/***  Begining of select statement *****************************************************************************************************************************/
--SELECT
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--            [RTRWv_row]         =  ROW_NUMBER()
--                                   OVER(ORDER BY  [Year]
--                                                , [level]                       DESC
--                                                , [Nation_fk]
--                                                , [Question_abbreviation_std]
--                                                , [Sorting_Order_v]                   )
--        ,   [Year]
--        ,   [level]
--        ,   [Nation_fk]
--        ,   [Region]
--        ,   [Question_abbreviation_std]
--        ,   [Question]
--        ,   [Sorting_Order_v]
--        ,   [Bar_Chart_Labels]
--        ,   [frequency]
--        ,   [percentage]
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--FROM
--              [forum_ResAnal].[dbo].[vi_Restrictions_Tables_by_region&world]
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--WHERE
--            [level]  != 2.5

--/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [forum]..[vi_Restrictions_Tables_by_region&world]                                      <<<<<     ***/
/***                                                                                                                                                         ***/
/***     NOTES:                                                                                                                                              ***/
/***           The view is based in a lookup table hosted at the default place for auxiliary fixed tables: [forum_ResAnal]                                   ***/
/***           Current VALUES are calculated and stored at [forum_ResAnal].[dbo].[vrc_06_LongData_ALL]                                                       ***/
/***                                                                                                                                                         ***/
/***        -----------------------------------------------------------------------------------------------------------------------------------------        ***/
/***       |   WHILE FINAL DATA ARE READY use wrkg version: [forum_ResAnal].[dbo].[vr_06w_LongData_ALL]                                              |       ***/
/***        -----------------------------------------------------------------------------------------------------------------------------------------        ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/**** database name specification for data sources (once) ******************************************************************************************************/
USE [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/
IF OBJECT_ID (N'[forum_ResAnal].[dbo].[vi_Restrictions_Tables_by_region&world]', N'U') IS NOT NULL
DROP   TABLE    [forum_ResAnal].[dbo].[vi_Restrictions_Tables_by_region&world]                   -- drop table if existent
/***************************************************************************************************************************************************************/
  IF OBJECT_ID('tempdb..[#extracted]') IS NOT NULL
  DROP TABLE            [#extracted]
  GO
  SELECT * INTO         [#extracted]  FROM
--select * from
/***************************************************************************************************************************************************************/
(
/*** Selected Data from long set *******************************************************************************************************************************/
--/***  Begining of select statement *****************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
         SELECT
                 [Year]      = D.[Question_Year]                 --CAST(D.[Question_Year] AS VARCHAR)
               , [Nation_fk] = CASE
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Nor' THEN 1001
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Lat' THEN 1002
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Eur' THEN 1003
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Mid' THEN 1004
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Sub' THEN 1005
                                   WHEN SUBSTRING([Region6], 1,3)   = 'Asi' THEN 1006
                               END
               , [Region]    = [Region6]
               , [QA_std]    = CASE
                                   WHEN                [QA_std] LIKE '%_ny%' 
                                   THEN STUFF(         [QA_std]      ,         
                                   ((CHARINDEX('_ny',  [QA_std])) + 3) , 1, '')
                                   ELSE                [QA_std]
                               END
               , [QW_std]    =                         [QW_std]
               , [AV_std]    = CASE
                                   WHEN
                                         (CAST((ISNULL([Answer_value], 0)) AS decimal(12,2)) > 1)
                                      AND(             [QA_std] LIKE 'GRI_19_'              +'[bcdefx]'
                                                    OR [QA_std] LIKE 'SHI_0'  +'[1,4,5]'+'_'+'[bcdefx]'  )
                                   THEN    '1.00'
                                   ELSE         ISNULL([Answer_value], '0.00')
                               END
               , [AW_std]    = CASE
                                   WHEN
                                         (CAST((ISNULL([Answer_value], 0)) AS decimal(12,2))  = 0)
                                      AND(             [QA_std] LIKE 'GRI_19_'              +'[bcdefx]'
                                                    OR [QA_std] LIKE 'SHI_0'  +'[1,4,5]'+'_'+'[bcdefx]'  )
                                   THEN    'No cases were found'
                                   WHEN
                                         (CAST((ISNULL([Answer_value], 0)) AS decimal(12,2)) >= 1)
                                      AND(             [QA_std] LIKE 'GRI_19_'              +'[bcdefx]'
                                                    OR [QA_std] LIKE 'SHI_0'  +'[1,4,5]'+'_'+'[bcdefx]'  )
                                   THEN    '1+ cases were found'
                                   ELSE    [answer_wording_std]
                               END
               , [fr]        = [CntWg]
               , [pcr]       = [R6Wg]
               , [pcw]       = [WTWg]
            FROM [vr___06_cDB_LongData_ALL_byCYQ]      D
               , [vr___08_cDB_Weights_f_TopLines]      W
           WHERE          D.[Nation_fk]
                        = W.[Nation_fk]
             AND          D.[Question_Year]
                        = W.[Question_Year]
             AND          D.[Locality]
                       IN            (
                                        'aggregated by country'
                                      , 'not detailed'           )
             AND          D.[QA_std] NOT IN   ('GFI', 'GRI', 'SHI', 'GRI_20_05_x1')
             AND          D.[QA_std] NOT LIKE 'XSG_S_%'
             AND          D.[QA_std] NOT LIKE '%_d'+'[a,b]'
             AND          D.[QA_std] NOT LIKE '%_rd_1d'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/******************************************************************************************************************************* Selected Data from long set ***/
)                                                                                                                                                      extracted
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***  MAIN TABLE  **********************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
SELECT * INTO [vi_Restrictions_Tables_by_region&world] 
FROM
     (
/*** FINAL TABLE ***********************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            [RTRWv_row]             =  ROW_NUMBER()
                                       OVER(ORDER BY
                                                 S.[Year]
                                               , S.[lV]        DESC
                                               , S.[Nation_fk]
                                               , S.[QA_std]
                                               , S.[AV_std]           )
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
      ,[Year]                       =                    S.[Year]
      ,[level]                      =         CAST(      S.[lv]       AS NUMERIC(2,1)) 
      ,[Nation_fk]                  =            S.[Nation_fk]
      ,[Region]                     =            S.[R]
      ,[Question_abbreviation_std]  =            S.[QA_std]
      ,[Question]                   =            S.[QW_std]
      ,[Sorting_Order_v]            =            S.[AV_std]
      ,[Bar_Chart_Labels]           =            S.[AW_std]
      ,[frequency]                  = ISNULL(            A.[freq]             , 0)
      ,[percentage]                 = ISNULL((CAST(ROUND(A.[perc], 0) AS INT)), 0) 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
  FROM
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** target sets & rows to be displayed ************************************************************************************************************************/
       ( 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
         SELECT * 
         FROM
               (           SELECT [lv] = 2, [Nation_fk] =  1001, [R] = 'North America'
                 UNION ALL SELECT [lv] = 2, [Nation_fk] =  1002, [R] = 'Latin America-Caribbean'
                 UNION ALL SELECT [lv] = 2, [Nation_fk] =  1003, [R] = 'Europe'
                 UNION ALL SELECT [lv] = 2, [Nation_fk] =  1004, [R] = 'Middle East-North Africa'
                 UNION ALL SELECT [lv] = 2, [Nation_fk] =  1005, [R] = 'Sub-Saharan Africa'
                 UNION ALL SELECT [lv] = 2, [Nation_fk] =  1006, [R] = 'Asia-Pacific'
                 UNION ALL SELECT [lv] = 3, [Nation_fk] = 10000, [R] = 'World'                      ) RW
         CROSS
         JOIN
       
              ( SELECT *
                FROM   [vi_Restrictions_Yr&Q&A_Displayable]
                WHERE  [QA_std] NOT IN ('GRI','SHI')        /*not in this view*/                    ) YQA      
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                                                                                                                                                            ) S
/************************************************************************************************************************ target sets & rows to be displayed ***/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LEFT OUTER JOIN
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** aggregated data by six regions and by the world ***********************************************************************************************************/
(
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT
       [Year]
      ,[Nation_fk]
      ,[Region]
      ,[QA_std]
      ,[QW_std]
      ,[AV_std]
      ,[AW_std]
      ,[freq]         = SUM([fr] )
      ,[perc]         = SUM([pcr])
  FROM [#extracted]
GROUP BY
       [Year]
      ,[Nation_fk]
      ,[Region]
      ,[QA_std]
      ,[QW_std]
      ,[AV_std]
      ,[AW_std]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
UNION
ALL
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT
       [Year]
      ,[Nation_fk]    = 10000
      ,[Region]       = 'World'
      ,[QA_std]
      ,[QW_std]
      ,[AV_std]
      ,[AW_std]
      ,[freq]         = SUM([fr] )
      ,[perc]         = SUM([pcw])
  FROM [#extracted]
GROUP BY
       [Year]
      ,[QA_std]
      ,[QW_std]
      ,[AV_std]
      ,[AW_std]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                                                                                                                                                            ) A
/*********************************************************************************************************** aggregated data by six regions and by the world ***/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
      ON          S.[Nation_fk]
               =  A.[Nation_fk]
      AND         S.[Year]
               =  A.[Year]
      AND         S.[QA_std]
               --  NOTE: this recoding is NECESSARY to avoid introducing different [QA_std] codes from those in the database
               --        we should keep a unique QA_std for the same question in all data sent to Intridea (2014.06.18.jceo)
               =  CASE WHEN A.[QA_std] = 'GRI_20_top'
                       THEN              'GRI_20_SUMMARY'
                       WHEN A.[QA_std] = 'GRI_20_03_top'
                       THEN              'GRI_20_03_SUMMARY'
                       ELSE A.[QA_std]                        END
      AND         S.[AV_std]
               =  A.[AV_std]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************************************************************************************************** FINAL TABLE ***/
                                                                                                                                                    ) FINALTABLE
/***************************************************************************************************************************************************************/
/**********************************************************************************************************************************************  MAIN TABLE  ***/
/***************************************************************************************************************************************************************/
GO