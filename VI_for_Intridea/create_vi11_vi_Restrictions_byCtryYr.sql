/* ++> create_vi11_vi_Restrictions_byCtryYr.sql <++ */
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [forum]..[vi_Restrictions_byCtryYr]                                                    <<<<<     ***/
/***                                                                                                                                                         ***/
/***     NOTES:                                                                                                                                              ***/
/***           Current Indexes are calculated and stored at [forum_ResAnal].[dbo].[vrc_06_LongData_ALL]                                                      ***/
/***                                                                                                                                                         ***/
/***        -----------------------------------------------------------------------------------------------------------------------------------------        ***/
/***       |   WHILE FINAL DATA ARE READY use wrkg version: [forum_ResAnal].[dbo].[vr_06w_LongData_ALL]                                              |       ***/
/***        -----------------------------------------------------------------------------------------------------------------------------------------        ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE [forum]
GO
/***************************************************************************************************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
ALTER  VIEW
              [dbo].[vi_Restrictions_byCtryYr]
AS
/***************************************************************************************************************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
           [RQYDv_row]
         = ROW_NUMBER()OVER(ORDER BY
           [VR].[Nation_fk]
         , [VR].[Question_Year]
         , [VR].[QA_std]            )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
      ,    [Q_Level]                     = CASE
                                          ----- slightly different wording: -------------------------------------------------------------------------------------
                                                WHEN [entity] = 'Stored by Country'
                                                THEN            'code stored by country'
                                                ELSE            'aggregated by country'                                                   END
                                          --------------------------------------------------------------------------------------------------- < recode ends -----
      , DQ.[Nation_fk]
      , VR.[Ctry_EditorialName]
      , DQ.[Question_Year]
      , DQ.[Question_abbreviation_std]      
      ,    [Question_short_wording_std]  = [QW_std]
      , VR.[Answer_value]
      , VR.[Answer_wording_std]
      ,    [Question_fk]                 = ISNULL([Question_fk], 999999)
      ,    [Answer_fk]                   = ISNULL([Answer_fk]  , 999999)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
FROM
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/*** country values and calculated median region & world values (from vr working tables)   *********************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       [forum_ResAnal].[dbo].[vr_06w_LongData_ALL]                                                     VR
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/********************************************************************* country values and calculated median region & world values (from vr working tables)   ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
RIGHT OUTER JOIN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
    (   SELECT *
        FROM
              [forum].[dbo].[vi_Restrictions_Ctry&Q&Yr_Displayable]
        WHERE Question_abbreviation_std NOT IN ('GRI', 'SHI') /* not for this view */   )         AS   DQ
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  ON   VR.Question_Year
     = DQ.Question_Year
 AND   VR.Nation_fk
     = DQ.Nation_fk
          --  NOTE: this recoding is NECESSARY to avoid introducing different [QA_std] codes from those in the database
          --        we should keep a unique QA_std for the same question in all data sent to Intridea (2014.06.18.jceo)
 AND   CASE WHEN VR.QA_std = 'GRI_20_top'
            THEN             'GRI_20_SUMMARY'
            WHEN VR.QA_std = 'GRI_20_03_top'
            THEN             'GRI_20_03_SUMMARY'
            --WHEN VR.QA_std = 'GRI_08'
            --THEN             'GRI_08_XXXXXXXXX'
            --WHEN VR.QA_std = 'GRI_08_for_index'
            --THEN             'GRI_08'
            --WHEN VR.QA_std = 'SHI_11'
            --THEN             'SHI_11_XXXXXXXXX'
            --WHEN VR.QA_std = 'SHI_11_for_index'
            --THEN             'SHI_11'
            ELSE VR.QA_std                       END
     = DQ.Question_abbreviation_std
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
GO
