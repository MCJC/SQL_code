/* ++> create_vi20___vi_Topic&Question&Related_Displayable.sql <++ */
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the table [forum_ResAnal]..[vi_Topic&Question&Related_Displayable]                              <<<<<     ***/
/***             NOTE:  This is a fixed table hosted at the default place for auxiliary fixed tables: [forum_ResAnal]                                        ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE
                [forum_ResAnal]
GO
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IF OBJECT_ID (N'[forum_ResAnal].[dbo].[vi_Topic&Question&Related_Displayable]', N'U') IS NOT NULL
DROP   TABLE    [forum_ResAnal].[dbo].[vi_Topic&Question&Related_Displayable]         -- drop table if existent
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GO
/***************************************************************************************************************************************************************/
SELECT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
           [TQRDv_row]
                                        = ROW_NUMBER()OVER(ORDER BY
                                                                       [Topic_sorting]
                                                                     , [SubTopic_Sorting]
                                                                     , [BySubTopic_QuestionSort]
                                                                     , [Report_SortingNumber]
                                                                                                  )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
      ,TSD.[Topic_fk]
      ,    [Topic]
      ,    [SubTopic]
      ,    [Question_Std_fk]
      ,    [Question_abbreviation_std]
      ,    [Question_short_wording_std]
      ,    [Question_wording_std]
      ,    [GRFsite_URL]
      ,    [Topic_sorting]
      ,    [SubTopic_Sorting]
      ,    [ByTopic_QuestionSort]
      ,    [BySubTopic_QuestionSort]
      ,    [Footnote]
      ,    [About_the_Data_link]
--      ,    [Note_SortingNumber]
      ,    [Reports]
      ,    [Report_Name_disitinct]
      ,    [Report_url]
      ,    [Report_SortingNumber]

-----------------------------------------------------------------------------------------------------------------------------------------------------------------
INTO
                [forum_ResAnal].[dbo].[vi_Topic&Question&Related_Displayable]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
FROM
/***************************************************************************************************************************************************************/
(
--  >>  topics/subtopics for data on Population Characteristics, Restrictions and Surveys  ----------------------------------------------------------------------
/***************************************************************************************************************************************************************/
----  >>  select topics/subtopics for Population Characteristics  -----------------------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
           [Topic_fk]                   =  tt.[Topic_pk]
      , TT.[Topic]
      , TT.[SubTopic]
      ,    [Question_Std_fk]            =  ''
      ,    [Question_abbreviation_std]  =  ''
      ,    [Question_short_wording_std] =  ''
      ,    [Question_wording_std]       =  ''
      , ST.[GRFsite_URL]
      , TT.[Topic_sorting]
      , TT.[SubTopic_Sorting]
      ,    [ByTopic_QuestionSort]       =  0  -- ST.[Priority_order]
      ,    [BySubTopic_QuestionSort]    =  0  -- ST.[Priority_order]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM
       [forum].[dbo].[Pew_Topic]                      TT
  JOIN
       [forum].[dbo].[Pew_GRFsite_URLs_Topic]         ST
    ON
         TT.[Topic_pk]
       = ST.[Topic_fk]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
WHERE
--------- >> FILTER: only for subtopics under Poc Char (no survey | no restrictions qustions) -------------------------------------------------------------------
       TT.[Topic] = 'Population Characteristics'
--------- << FILTER: only for subtopics under Poc Char (no survey | no restrictions qustions) -------------------------------------------------------------------
  AND
--------- >> FILTER: some TOPICS are NOT ALLOWED to display (should be consistent to the URL's to be displayed) -------------------------------------------------
       TT.[Display] = 1
  AND
       ST.[Display] = 1
--------- << FILTER: some TOPICS are NOT ALLOWED to display (should be consistent to the URL's to be displayed) -------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
----  <<  select topics/subtopics for Population Characteristics  -----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
UNION ALL
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
----  >>  select topics/subtopics for Restrictions data  --------------------------------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        distinct
        QT.[Topic_fk]
      , TT.[Topic]
      , TT.[SubTopic]
      ,    [Question_Std_fk]            =  QS.[Question_Std_pk]
      , QS.[Question_abbreviation_std]
      , QS.[Question_short_wording_std]
      , QS.[Question_wording_std]
      ,    [GRFsite_URL]                =  ''
      , TT.[Topic_sorting]
      , TT.[SubTopic_Sorting]
      ,    [ByTopic_QuestionSort]       =  QT.[Topic_Priority_order]
      ,    [BySubTopic_QuestionSort]    =  QT.[SubTopic_Priority_order]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM  
       [forum].[dbo].[vi_Restrictions_Ctry&Q&Yr_Displayable]   RQ
  JOIN
       [forum].[dbo].[Pew_Question_Std]                        QS
    ON
         RQ.[Question_abbreviation_std]
       = QS.[Question_abbreviation_std]
  JOIN
       [forum].[dbo].[Pew_Question_Topic]                      QT
    ON 
        QT.[Question_Std_fk]
      = QS.[Question_Std_pk]
  JOIN
       [forum].[dbo].[Pew_Topic]                               TT
    ON 
        [Topic_fk]
      = [Topic_pk]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
WHERE
--------- >> FILTER: questions can be allowed to display uunder 1 or more topics, but some TOPICS are NOT ALLOWED to display ------------------------------------
       TT.[Display] = 1
--------- << FILTER: questions can be allowed to display uunder 1 or more topics, but some TOPICS are NOT ALLOWED to display ------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
----  <<  select topics/subtopics for Restrictions data  --------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
UNION ALL
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
----  >>  select topics/subtopics for Survey data  --------------------------------------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        distinct
        QT.[Topic_fk]
      , TT.[Topic]
      , TT.[SubTopic]
      , SD.[Question_Std_fk]
      , SD.[Question_abbreviation_std]
      , SD.[Question_short_wording_std]
      , SD.[Question_wording_std]
      ,    [GRFsite_URL]               =  ''
      , TT.[Topic_sorting]
      , TT.[SubTopic_Sorting]
      ,    [ByTopic_QuestionSort]      =  QT.[Topic_Priority_order]
      ,    [BySubTopic_QuestionSort]   =  QT.[SubTopic_Priority_order]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM  
       [forum].[dbo].[vi_Survey_Tables_Displayable]   SD
  JOIN
       [forum].[dbo].[Pew_Question_Topic]             QT
    ON 
        QT.[Question_Std_fk]
      = SD.[Question_Std_fk]
  JOIN
       [forum].[dbo].[Pew_Topic]                      TT
    ON 
        [Topic_fk]
      = [Topic_pk]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
WHERE
--------- >> FILTER: questions can be allowed to display uunder 1 or more topics, but some TOPICS are NOT ALLOWED to display ------------------------------------
       TT.[Display] = 1
--------- << FILTER: questions can be allowed to display uunder 1 or more topics, but some TOPICS are NOT ALLOWED to display ------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
----  <<  select topics/subtopics for Survey data  --------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
--  <<  topics/subtopics for data on Population Characteristics, Restrictions and Surveys  ----------------------------------------------------------------------
)   AS TSD
/***************************************************************************************************************************************************************/
LEFT JOIN
/***************************************************************************************************************************************************************/
(
--  >>  footnotes to be displayed for each topic  ---------------------------------------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       [Topic_fk]
      ,[Footnote_Display]          AS [Footnote]
      ,[About_the_Data_link]
      ,[Note_SortingNumber]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM [forum].[dbo].[Pew_Display_Footnotes]
      ,[forum].[dbo].[Pew_Footnote]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
WHERE
       [Note_pk]
      =[Note_fk]
/***************************************************************************************************************************************************************/
--  <<  footnotes to be displayed for each topic  ---------------------------------------------------------------------------------------------------------------
)   AS FND
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
ON
       FND.[Topic_fk]
     = TSD.[Topic_fk]
/***************************************************************************************************************************************************************/
LEFT JOIN
/***************************************************************************************************************************************************************/
(
--  >>  reports to be displayed for each topic  -----------------------------------------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       [Topic_fk]
      ,[Reports]         = CASE
                                WHEN [3] IS NOT NULL THEN CAST(([1] + ' / ' + [2] + ' / ' + [3]) AS NVARCHAR(MAX))
                                WHEN [2] IS NOT NULL THEN CAST(([1] + ' / ' + [2]              ) AS NVARCHAR(MAX))
                                WHEN [1] IS NOT NULL THEN CAST(([1]                            ) AS NVARCHAR(MAX))
                                WHEN [1] IS     NULL THEN CAST(('ERROR!'                       ) AS NVARCHAR(MAX))
                             END
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  FROM
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
( SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          [Topic_fk]
         ,[Source_Display_Name]
         ,[Report_SortingNumber]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
     FROM [forum].[dbo].[Pew_Display_Reports]
        , [forum].[dbo].[Pew_Data_Source]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
    WHERE
          [Data_source_fk]
         =[Data_source_pk]
      AND
          [GRF_Level]
         = 'reports'
      --AND
      --    [Topic_fk]
      --    IS NOT NULL
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
   ) mypivoted
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
PIVOT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       (MAX([Source_Display_Name]) 
        FOR [Report_SortingNumber]
        IN (
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
              [1]
             ,[2]
             ,[3]
             --,[4]
             --,[5]
                       )) 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
                          as pivotingkey
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
--  <<  reports to be displayed for each topic  -----------------------------------------------------------------------------------------------------------------
)   AS RPD
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
ON
       RPD.[Topic_fk]
     = TSD.[Topic_fk]
/***************************************************************************************************************************************************************/
LEFT JOIN
/***************************************************************************************************************************************************************/
(
--  >>  distinct reports (as well as links) to be displayed by topic & question  --------------------------------------------------------------------------------
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          [Topic_fk]
         ,[Report_Name_disitinct] = [Source_Display_Name]
         ,[Report_url]            = [Data_source_url]
         ,[Report_SortingNumber]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
     FROM [forum].[dbo].[Pew_Display_Reports]
        , [forum].[dbo].[Pew_Data_Source]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
    WHERE
          [Data_source_fk]
         =[Data_source_pk]
      AND
          [GRF_Level]
         = 'reports'
      --AND
      --    [Topic_fk]
      --    IS NOT NULL
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
--  <<  distinct reports (as well as links) to be displayed by topic & question  --------------------------------------------------------------------------------
)   AS RLT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
ON
       RLT.[Topic_fk]
     = TSD.[Topic_fk]
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
go