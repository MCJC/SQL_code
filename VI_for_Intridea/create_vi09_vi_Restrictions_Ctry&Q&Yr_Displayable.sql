/* ++> create_vi09_vi_Restrictions_Ctry&Q&Yr_Displayable.sql <++ */
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [forum]..[vi_Restrictions_Ctry&Q&Yr_Displayable]                                       <<<<<     ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
--- rcreate later!!!!!!!!!!!!!!


USE [forum]
GO
/***************************************************************************************************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
ALTER  VIEW
              [dbo].[vi_Restrictions_Ctry&Q&Yr_Displayable]
AS
/***************************************************************************************************************************************************************/
-- Notice that:
-- the statement " distinct Question_abbreviation_std, Question_Year '
-- does not give all cases, because:
--      - GFI, GRI, SHI        are in Pew_Question_Std but not in Pew_Question
--      - GRI_20_SUMMARY &
--        GRI_20_03_SUMMARY    are in Pew_Question_Std but not in Pew_Question for 2012
--      - SHI_01_summary_a &
--        SHI_01_summary_b     are in Pew_Question_Std but not in Pew_Question by year
/***************************************************************************************************************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/*** Restrictions Questions for each year **********************************************************************************************************************/
SELECT 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
         [RQYDv_row]
         = ROW_NUMBER()OVER(ORDER BY
           [Nation_fk]
          ,[Question_abbreviation_std]
          ,[Question_Year]             )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       ,  Nation_fk
       ,  Ctry_EditorialName
       ,  Q_Level                    = CASE
                                       WHEN Question_abbreviation_std
                                            IN (  'GFI'
                                                , 'GRI'
                                                , 'GRI_20_summary'
                                                , 'GRI_20_03_summary'
                                                , 'SHI'
                                                , 'SHI_01_summary_a'
                                                , 'SHI_01_summary_b'  )
                                       THEN   'aggregated by country'
                                       ELSE   'code stored by country'
                                       END
       ,  Question_abbreviation_std
       ,  Question_short_wording_std
       ,  Question_Year
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
FROM
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
(
/*** Restrictions Questions for each year (filter not included country/year ************************************************************************************/
SELECT * FROM
/*** List of years (should be updated in the corresponding table) **********************************************************************************************/
(  SELECT [Question_Year] = [Year]
     FROM [Pew_Display_by_Year]
    WHERE [Restrictions_Data] = 1 
) AS YR
/************************************************************************************************************************* List of years (should be updated) ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
CROSS JOIN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
(
/*** List of countries (should be evetually updated) ***********************************************************************************************************/
 SELECT 
        [Nation_fk] = [Nation_pk]
      , [Ctry_EditorialName]
   FROM [forum].[dbo].[Pew_Nation]
 WHERE   [Nation_pk] NOT IN
                            (    	4	 -- 	American Samoa
                               , 	7	 -- 	Anguilla
                               , 	11	 -- 	Aruba
                               , 	23	 -- 	Bermuda
                               , 	29	 -- 	British Virgin Islands
                               , 	38	 -- 	Cayman Islands
                               , 	41	 -- 	Channel Islands
                               , 	48	 -- 	Cook Islands
                               , 	66	 -- 	Faeroe Islands
                               , 	67	 -- 	Falkland Islands (Malvinas)
                               , 	71	 -- 	French Guiana
                               , 	72	 -- 	French Polynesia
                               , 	78	 -- 	Gibraltar
                               , 	80	 -- 	Greenland
                               , 	82	 -- 	Guadeloupe
                               , 	83	 -- 	Guam
                               , 	89	 -- 	Vatican City
                               , 	99	 -- 	Isle of Man
                               , 	129	 -- 	Martinique
                               , 	132	 -- 	Mayotte
                               , 	139	 -- 	Montserrat
                               , 	147	 -- 	Netherlands Antilles
                               , 	148	 -- 	New Caledonia
                               , 	153	 -- 	Niue
                               , 	154	 -- 	North Korea
                               , 	155	 -- 	Northern Mariana Islands
                               , 	169	 -- 	Puerto Rico
                               , 	171	 -- 	Reunion
                               , 	175	 -- 	St. Helena
                               , 	178	 -- 	St. Pierre and Miquelon
                               , 	209	 -- 	Tokelau
                               , 	215	 -- 	Turks and Caicos Islands
                               , 	222	 -- 	U.S. Virgin Islands
                               , 	228	 -- 	Wallis and Futuna
                               , 	238  --		Curacao
                               , 	239  --		Sint Maarten
                               , 	240	)-- 	Caribbean Netherlands
/********************************************************************************************************************** List of countries (should be updated ***/
) AS CTRY
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
CROSS JOIN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
(
/*** MAIN Restrictions Questions *******************************************************************************************************************************/
SELECT
          Question_abbreviation_std
        , Question_short_wording_std
  FROM     [forum].[dbo].[Pew_Question_std]
WHERE     Question_abbreviation_std IN
(
  'GRI'
, 'GRI_01'
, 'GRI_02'
, 'GRI_03'
, 'GRI_04'
, 'GRI_05'
, 'GRI_06'
, 'GRI_07'
, 'GRI_08'
, 'GRI_09'
, 'GRI_10'
, 'GRI_11'
, 'GRI_12'
, 'GRI_13'
, 'GRI_14'
, 'GRI_15'
, 'GRI_16'
, 'GRI_17'
, 'GRI_18'
, 'GRI_19'
--, 'GRI_19_b'
--, 'GRI_19_c'
--, 'GRI_19_d'
--, 'GRI_19_e'
--, 'GRI_19_f'
, 'GRI_20_SUMMARY'
, 'GRI_20_01'
, 'GRI_20_02'
, 'GRI_20_03_SUMMARY'
, 'GRI_20_03_a'
, 'GRI_20_03_b'
, 'GRI_20_03_c'
, 'GRI_20_04'
, 'GRI_20_05'
, 'SHI'
--, 'SHI_01_summary_a'   -- removed, cannot be tabulated as displayed in GRF website (2014.06.18.jceo)
, 'SHI_01_summary_b'
, 'SHI_02'
, 'SHI_03'
, 'SHI_04'
, 'SHI_05'
, 'SHI_06'
, 'SHI_07'
, 'SHI_08'
, 'SHI_09'
, 'SHI_10'
, 'SHI_11'
, 'SHI_12'
, 'SHI_13'
--, 'GFI'                -- removed, it is not currently displayed in GRF website (2014.06.18.jceo)
)
/******************************************************************************************************************************* MAIN Restrictions Questions ***/
) AS VARS
/********************************************************************************************************************** Restrictions Questions for each year ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
WHERE 
      NOT ( Nation_fk = 237 AND Question_Year < 2011)      -- filter out data not gathered for South Sudan
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
) AS REYF
/************************************************************************************ Restrictions Questions for each year (filter not included country/year ***/
go