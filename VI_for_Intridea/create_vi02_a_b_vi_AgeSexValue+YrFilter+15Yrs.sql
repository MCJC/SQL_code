/* ++> create_vi02_a_b_vi_AgeSexValue+YrFilter+15Yrs.sql <++ */
--/***************************************************************************************************************************************************************/
--USE [forum]
--GO
--/***************************************************************************************************************************************************************/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
--/***************************************************************************************************************************************************************/
--ALTER  VIEW
--               [dbo].[vi_AgeSexValue]
--AS
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--SELECT
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--       [ASVv_row]        = ROW_NUMBER()
--                           OVER(ORDER BY
--                                        [year]
--                                      , [level]        DESC
--                                      , [Nation_fk]
--                                      , [Religion]
--                                      , [Religion_fk]  DESC
--                                      , [SubReligion]
--                                      , [Sex_fk]
--                                      , [Age_fk]             )
--        , [Year]
--        , [level]
--        , [SubRegion6_code]
--        , [Nation_fk]
--        , [Region]
--        , [Country]
--        , [Religion_fk]
--        , [Religion]
--        , [SubReligion]
--        , [Sex]
--        , [Age]
--        , [TotPopulat]        = CAST ( ROUND([TotPopulat]       , 0) AS DECIMAL (12,0) )
--		                        /* CONVERT(varchar, CAST(ROUND([TotPopulat], 0) AS money), 0) -- */
--        , [Population]        = CAST ( ROUND([Population]       , 0) AS DECIMAL (12,0) )
--        , [Percentage]        = CAST ( ROUND([Percentage]       , 1) AS DECIMAL ( 5,1) )
--        , [Pct_by_AgeCohorts] = CAST ( ROUND([Pct_by_AgeCohorts], 1) AS DECIMAL ( 6,2) )
--        , [Data_source_fk]
--        , [NV_Display_AgeStr_15Yrs] = [NV_Display]
--        , [RV_Display_AgeStr_15Yrs] = [RV_Display]
--        , [Sex_fk]
--        , [Age_fk]
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--   FROM [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
--WHERE
--/***            [Sex_fk]       = 0        -- filter removed on March 2016   ***/
--/***  AND                                                                   ***/
--      NOT (     [Religion_fk] IS NULL
--            AND [Year]        != '2010'   )                            --  150,697 (p)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--AND
--                [Year]        IN ( 2010, 2020, 2030, 2040, 2050 )      --   68,239 (checked)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--AND
--                [NV_Display]   = 1
--AND
--      NOT (     [Religion_fk] !=  52
--            AND [RV_Display]   =   0      )                            --   34,159 (provisionally checked)
--/***************************************************************************************************************************************************************/
--/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
-- select *                 from [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
--  C&R    R&A   7A&3S    Y 
--  241  *  9  *    7  *  1   =   15,183      --   2010 (m+f) population + all religions & age cohorts
--  241  *  9  *   14  *  1   =               --   2010 population + all religions & age/sex cohorts
--  241  *  4  *    1  *  1   =      964      --   2010 subreligions for (m+f) total population
--  241  *  9  *    1  * 10   =   21,690      -- > 2010 total (m+f) population by country and by religion
--  209  *  9  *    6  * 10   =  112,860      -- > 2010 6 age cohorts (m+f) by country and by religion, when data are available
--  209  *  9  *   14  * 10   =               -- > 2010 14 age/sex cohorts by country and by religion, when data are available
--  241  *  4  *    1  * 10   =               -- > 2010 subreligions for total population
---------------------------------------------
--                            =  150,697
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [forum]..[vi_AgeSexValue]                                                              <<<<<     ***/
/***             NOTE:  The view is based on a fixed table hosted at [forum_ResAnal]                                                                         ***/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the table [forum_ResAnal]..[vi_AgeSexValue_15Yrs]                                               <<<<<     ***/
/***             NOTE:  This is a fixed table hosted at the default place for auxiliary fixed tables: [forum_ResAnal]                                        ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/**** database name specification [forum_ResAnal] because it is the default place for auxiliary fixed tables) **************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
USE              [forum_ResAnal]
GO
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IF OBJECT_ID (N'[forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]', N'U') IS NOT NULL
DROP   TABLE    [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]                                     -- drop table if existent
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GO
/***************************************************************************************************************************************************************/
SELECT
----------------------------------------------------------------------------------------------------------------------------
      [ASVv_row]        = ROW_NUMBER()
                           OVER(ORDER BY
                                        [year]
                                      , [level] DESC
                                      , [Nation_fk]
                                      , [Religion]
                                      , [SubReligion]
                                      , [Sex_fk]
                                      , [Age_fk]        )
    , *
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    INTO  [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]    -- 454,043 (p) is: 1,595,668
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
FROM
/***************************************************************************************************************************************************************/
(
----- step IV calculate percentage by age cohort ---------------------------------------------------------------------------
SELECT
----------------------------------------------------------------------------------------------------------------------------
       [Year]
      ,[level]
      ,[SubRegion6_code]
      ,[Nation_fk]
      ,[Region]
      ,[Country]
      ,[Religion_fk]
      ,[Religion]
      ,[SubReligion]
      ,[Sex]
      ,[Age]
      ,[TotPopulat]
      ,[Population]
      ,[Percentage]
      ,[Pct_by_AgeCohorts] = CASE WHEN                  [All_age_cohorts]     <> 0
                                  THEN ( [Population] / [All_age_cohorts] ) * 100
                                  ELSE NULL                                           END
      ,[Data_source_fk]
      ,[NV_Display]
      ,[RV_Display]
      ,[Sex_fk]
      ,[Age_fk]
----------------------------------------------------------------------------------------------------------------------------
FROM
/**************************************************************************************************************************/
(
/**************************************************************************************************************************/
----- step III calculate percentage ----------------------------------------------------------------------------------------
SELECT
----------------------------------------------------------------------------------------------------------------------------
       [ASVv_row]        = ROW_NUMBER()
                           OVER(ORDER BY
                                        [year]
                                      , [level] DESC
                                      , [Nation_fk]
                                      , [Religion]
                                      , [SubReligion]
                                      , [Sex_fk]
                                      , [Age_fk]        )
      ,[Year]
      ,[level]
      ,[SubRegion6_code] =
                           CASE
                               WHEN [Region] = 'North America'             THEN 1001
                               WHEN [Region] = 'Latin America-Caribbean'   THEN 1002
                               WHEN [Region] = 'Europe'                    THEN 1003
                               WHEN [Region] = 'Middle East-North Africa'  THEN 1004
                               WHEN [Region] = 'Sub-Saharan Africa'        THEN 1005
                               WHEN [Region] = 'Asia-Pacific'              THEN 1006
                           END
      ,[Nation_fk]
      ,[Region]
      ,[Country]
      ,[Religion_fk]
      ,[Religion]
      ,[SubReligion]
      ,[Sex]
      ,[Age]
      ,[TotPopulat]
      ,[Population]
      ,[Percentage]      = ( [Population] / [TotPopulat] ) * 100
      ,[Data_source_fk]
      ,[NV_Display]
      ,[RV_Display]
      ,[Sex_fk]
      ,[Age_fk]
----------------------------------------------------------------------------------------------------------------------------
      ,[All_age_cohorts] = SUM([Population]) 
                           OVER(PARTITION BY [year]
                                           , [Nation_fk]
                                           , [Religion]
                                           , [SubReligion]
                                           , [Sex_fk]
                                           , CASE
                                             WHEN [Age_fk] > 0
                                             THEN 1
                                             ELSE [Age_fk]     END    )
      , [age_all]        =                   CASE
                                             WHEN [Age_fk] > 0
                                             THEN 0
                                             ELSE 1            END
----------------------------------------------------------------------------------------------------------------------------
FROM
/**************************************************************************************************************************/
(
/**************************************************************************************************************************/
----- step II collapse counts ----------------------------------------------------------------------------------------------
SELECT
----------------------------------------------------------------------------------------------------------------------------
       [Year]
      ,[level]
      ,[Nation_fk]
      ,[Region]
      ,[Country]
      ,[Religion_fk]
      ,[Religion]
      ,[SubReligion]
      ,[Sex]
      ,[Age]
      ,[TotPopulat]      = SUM([TotPopulat])
      ,[Population]      = SUM([Population])
      ,[Data_source_fk]
      ,[NV_Display]      = MIN([NV_Display])
      ,[RV_Display]      = MIN([RV_Display])
      ,[Sex_fk]
      ,[Age_fk]
----------------------------------------------------------------------------------------------------------------------------
FROM
/**************************************************************************************************************************/
(
/**************************************************************************************************************************/
----- step I recode all years ----------------------------------------------------------------------------------------------
SELECT
----------------------------------------------------------------------------------------------------------------------------
       [Year]
      ,[level]
      ,[Nation_fk]
      ,[Region]
      ,[Country]
      ,[Religion_fk]
      ,[Religion]
      ,[SubReligion]
      ,[Sex]
      ,[Age]                  = CASE 
                                     WHEN Age = 'all'   THEN 'all'
                                     WHEN Age = '0-4'   THEN '0-14'
                                     WHEN Age = '5-9'   THEN '0-14'
                                     WHEN Age = '10-14' THEN '0-14'
                                     WHEN Age = '15-19' THEN '15-29'
                                     WHEN Age = '20-24' THEN '15-29'
                                     WHEN Age = '25-29' THEN '15-29'
                                     WHEN Age = '30-34' THEN '30-44'
                                     WHEN Age = '35-39' THEN '30-44'
                                     WHEN Age = '40-44' THEN '30-44'
                                     WHEN Age = '45-49' THEN '45-59'
                                     WHEN Age = '50-54' THEN '45-59'
                                     WHEN Age = '55-59' THEN '45-59'
                                     WHEN Age = '60-64' THEN '60-74'
                                     WHEN Age = '65-69' THEN '60-74'
                                     WHEN Age = '70-74' THEN '60-74'
                                     WHEN Age = '75-79' THEN '75+'
                                     WHEN Age = '80-84' THEN '75+'
                                     WHEN Age = '85-89' THEN '75+'
                                     WHEN Age = '90-94' THEN '75+'
                                     WHEN Age = '95+'   THEN '75+'
                               END
      ,[TotPopulat]
      ,[Population]
      ,[Data_source_fk]
      ,[NV_Display]           = [NV_Display_AgeStr_15Yrs]
      ,[RV_Display]           = [RV_Display_AgeStr_15Yrs]
      ,[Sex_fk]
      ,[Age_fk]               = CASE 
                                     WHEN Age_fk =  0 THEN  0
                                     WHEN Age_fk = 10 THEN 80
                                     WHEN Age_fk = 11 THEN 80
                                     WHEN Age_fk = 12 THEN 80
                                     WHEN Age_fk = 13 THEN 81
                                     WHEN Age_fk = 14 THEN 81
                                     WHEN Age_fk = 15 THEN 81
                                     WHEN Age_fk = 16 THEN 82
                                     WHEN Age_fk = 17 THEN 82
                                     WHEN Age_fk = 18 THEN 82
                                     WHEN Age_fk = 19 THEN 83
                                     WHEN Age_fk = 20 THEN 83
                                     WHEN Age_fk = 21 THEN 83
                                     WHEN Age_fk = 22 THEN 84
                                     WHEN Age_fk = 23 THEN 84
                                     WHEN Age_fk = 24 THEN 84
                                     WHEN Age_fk = 25 THEN 85
                                     WHEN Age_fk = 26 THEN 85
                                     WHEN Age_fk = 27 THEN 85
                                     WHEN Age_fk = 28 THEN 85
                                     WHEN Age_fk = 29 THEN 85
                               END
      ,[det_Age]              = [Age]
      ,[det_Age_fk]           = [Age_fk]
----------------------------------------------------------------------------------------------------------------------------
  FROM [forum_ResAnal].[dbo].[vi_AgeSexValue_AllYears]         --  1,461,035

WHERE
       [Age_fk]                 NOT IN ( 91, 92 )  
---------------------------------------------------------------------------------------------- step I recode all years -----
--and nation_fk=194
/**************************************************************************************************************************/
)                                                                                                                      AS r
/**************************************************************************************************************************/
----------------------------------------------------------------------------------------------------------------------------
GROUP BY
       [Year]
      ,[level]
      ,[Nation_fk]
      ,[Region]
      ,[Country]
      ,[Religion_fk]
      ,[Religion]
      ,[SubReligion]
      ,[Sex]
      ,[Age]
      ,[Data_source_fk]
      ,[Sex_fk]
      ,[Age_fk]
---------------------------------------------------------------------------------------------- step II collapse counts -----
/**************************************************************************************************************************/
)                                                                                                                      AS c
/**************************************************************************************************************************/
---------------------------------------------------------------------------------------- step III calculate percentage -----
/**************************************************************************************************************************/
)                                                                                                                      AS p
/**************************************************************************************************************************/
-------------------------------------------------------------------------- step IV calculate percentage by age cohort  -----
/***************************************************************************************************************************************************************/
) ASV15y
/***************************************************************************************************************************************************************/
----------------------------------------------------------------------------------------------------------------------------
-- select distinct [Age_fk] FROM [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
----------------------------------------------------------------------------------------------------------------------------
-- select *                 from [forum_ResAnal].[dbo].[vi_AgeSexValue_15Yrs]
--  C&R    R&A   7A&3S    Y 
--  241  *  9  *   21  *  1   =   45,549      --   2010 population + all religions & cohorts
--  241  *  4  *    1  *  1   =      964      --   2010 subreligions for total population
--  241  *  9  *    1  * 10   =   21,690      -- > 2010 total population by country and by religion
--  209  *  9  *    6  * 10   =  112,860      -- > 2010 6 age cohorts (m+f) by country and by religion, when data are available
--  209  *  9  *   14  * 10   =  263,340      -- > 2010 14 age/sex cohorts by country and by religion, when data are available
--  241  *  4  *    1  * 10   =    9,640      -- > 2010 subreligions for total population
---------------------------------------------
--                            =  454,043
/**************************************************************************************************************************/
GO