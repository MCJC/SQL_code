/*****************************************************************************************************************************************/
USE [forum]
GO
/*****************************************************************************************************************************************/
/*****                                                     BackUp current  Table                                                     *****/
/*****************************************************************************************************************************************/
  DECLARE @CrDt    varchar( 8)
  SET     @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
EXEC (' SELECT * INTO  [_bk_forum].[dbo].[Pew_Nation_Answer_' + @CrDt + 'a]
                 FROM      [forum].[dbo].[Pew_Nation_Answer]'               )
/*****************************************************************************************************************************************/
/*****                                                   Load changes - Temp Table                                                   *****/
/*****************************************************************************************************************************************/
--Hi Juan Carlos,
--                If GRI_20 is calculated in SQL (i.e. you don’t need new values for GRI_20 when the GRI_20 components change)
--                then there are only two changes. [...]
/***************************************************************************************************************************************************************/
  IF OBJECT_ID('tempdb..[#MYTEMPTABLE]') IS NOT NULL
  DROP TABLE            [#MYTEMPTABLE]
  SELECT * INTO         [#MYTEMPTABLE] 
FROM  (
/*---------------------------------------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
SELECT 
       [QA_std]                = ty.[QA_std]              --  x.[E]
      ,[Ctry]                  = ty.[Ctry_EditorialName]  --  x.[D]
      ,[currAns_fk]            = ty.[Answer_fk]
      ,[currAnsVal]            = ty.[Answer_value]        --  x.[A]
      ,[updtAnsVal]            = tx.[F]                   --  x.[F]
      ,[41_NA_lk]              = ty.[link_fk]
      ,[41_updtAns_fk]         = A1.[Answer_pk]
      ,[TASK]                  = 'updt Ans_fk-PNA'
--select *
  FROM 
/*=======================================================================================================================================*/
		(
		 ---------------- old value   Country               chngd question     new value   ------
				   SELECT [A] = 0.4 , [D] = 'Pakistan'    , [E] = 'GRI_19'   , [F] = 1
		 UNION ALL SELECT [A] = 0   , [D] = 'Russia'	  , [E] = 'SHI_05'   , [F] = 0.25	
         ----------------------------------------------------------------------------------------
																								 ) tx   -- MYUPDATES
/*=======================================================================================================================================*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
    INNER
     JOIN
/*---------------------------------------------------------------------------------------------------------------------------------------*/
/*=======================================================================================================================================*/
		(
         ----------------------------------------------------------------------------------------
                   SELECT * FROM [forum_ResAnal]..[vr___01_cDB_Long__NoAggregated]
                           WHERE [Question_Year] = 2014
         ----------------------------------------------------------------------------------------
																								 ) ty   -- MYCURDATA
/*=======================================================================================================================================*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
                  ON tx.[E] = ty.[QA_std]
                 AND tx.[D] = ty.[Ctry_EditorialName]
                 AND tx.[A] = ty.[Answer_value]
/*---------------------------------------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
     LEFT
     JOIN
/*=======================================================================================================================================*/
/*=======================================================================================================================================*/
         ----------------------------------------------------------------------------------------
                                 [forum]..[Pew_Answer_NoStd]
         ----------------------------------------------------------------------------------------
																								   A1   -- DataForNSAnsws
/*=======================================================================================================================================*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
         ON A1.[Question_fk]        = ty.[Question_fk]
        AND A1.[Answer_value_NoStd] = tx.[F] -- ([updtAnsVal])
/*---------------------------------------------------------------------------------------------------------------------------------------*/
                                                                                                                                 ) FKUPDT
/*---------------------------------------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
  SELECT * FROM         [#MYTEMPTABLE] 
/***************************************************************************************************************************************************************/




/***************************************************************************************************************************************************************/
-- 4.     changes on [Pew_Nation_Answer]
---------- [Nation_answer_pk]                      same
---------- [Nation_fk]                             same
---------- [Answer_fk]                             --->  UPDATE
---------- [display]                               same
/*****************************************************************************************************************************************/
	UPDATE
           [forum].[dbo].[Pew_Nation_Answer]
	SET                                               [Answer_fk]       = mynew.[41_updtAns_fk]
/*---------------------------------------------------------------------------------------------------------------------------------------*/
--select *
FROM
           [forum].[dbo].[Pew_Nation_Answer]                        AS mydbt
 JOIN                    [#MYTEMPTABLE]                             AS mynew
 
ON
           mydbt.[Nation_answer_pk]
       =   mynew.[41_NA_lk]
GO
/*****************************************************************************************************************************************/
/*****************************************************************************************************************************************/

