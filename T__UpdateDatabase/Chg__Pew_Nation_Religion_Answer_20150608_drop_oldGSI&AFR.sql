/**************************************************************************************************************************/
/*****                                              BackUp current Table                                              *****/
/**************************************************************************************************************************/
  DECLARE @CrDt    varchar( 8)
  DECLARE                          --  declare variable
          @TofI                    --  variable name
                   varchar(50)     --  data type of the variable
  SET     @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
/*------------------------------------------------------------------------------------------------------------------------*/
EXEC ( ' SELECT *
                INTO  [_bk_forum].[dbo].[Pew_Nation_Religion_Answer_' + @CrDt + ']
                FROM      [forum].[dbo].[Pew_Nation_Religion_Answer]' )
/*------------------------------------------------------------------------------------------------------------------------*/
/**************************************************************************************************************************/
-- After asking Neha Saghal on June 4 2015, CSP data shuld be dropped from the database

/**************************************************************************************************************************/
/*****                                                                                                                *****/
/*****                            basic cleaning for unvalid links to [Pew_Answer_NoStd]                              *****/
/*****                                                                                                                *****/
/**************************************************************************************************************************/
/**************************************************************************************************************************/
/* >   .  check consistency of Country/Religion/Province/Individual data linked to answers ********************************/
/*------------------------------------------------------------------------------------------------------------------------*/
	SELECT *                                                                   /* start TEST from this statement...       */
/*------------------------------------------------------------------------------------------------------------------------*/
  FROM                                                                         /*                                         */
/*------------------------------------------------------------------------------------------------------------------------*/
(
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          [Tab_fk]               = [Svy_RespAnswer_pk]
         ,[Ent_fk]               = [Svy_Respondent_fk]
         ,[Ans_fk]               = [Answer_fk]
         ,[Tab_id]               = 'PSRA'
                                                               FROM [forum].[dbo].[Pew_Survey_Respondent_Answer]
/*------------------------------------------------------------------------------------------------------------------------*/
   union
   all
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          [Tab_fk]               = [Pew_Survey_Answer_pk] 
         ,[Ent_fk]               = [Nation_fk]
         ,[Ans_fk]               = [Answer_fk]
         ,[Tab_id]               = 'PSA'
                                                               FROM [forum].[dbo].[Pew_Survey_Answer]
/*------------------------------------------------------------------------------------------------------------------------*/
   union
   all
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          [Tab_fk]               = [Nation_religion_answer_pk]
         ,[Ent_fk]               = [Nation_fk]
         ,[Ans_fk]               = [Answer_fk]
         ,[Tab_id]               = 'PNRA'
                                                               FROM [forum].[dbo].[Pew_Nation_Religion_Answer]
/*------------------------------------------------------------------------------------------------------------------------*/
   union
   all
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          [Tab_fk]               = [Nation_answer_pk]
         ,[Ent_fk]               = [Nation_fk]
         ,[Ans_fk]               = [Answer_fk]
         ,[Tab_id]               = 'PNA'
                                                               FROM [forum].[dbo].[Pew_Nation_Answer]
/*------------------------------------------------------------------------------------------------------------------------*/
   union
   all
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          [Tab_fk]               = [Locality_answer_pk]
         ,[Ent_fk]               = [Locality_fk]
         ,[Ans_fk]               = [Answer_fk]
         ,[Tab_id]               = 'PLA'
                                                               FROM [forum].[dbo].[Pew_Locality_Answer]
/*------------------------------------------------------------------------------------------------------------------------*/
                                                                                                            ) PewLinkedAns    --> 2,360,156
/*------------------------------------------------------------------------------------------------------------------------*/
	inner
--	left
--	right
--	full
	join
/*------------------------------------------------------------------------------------------------------------------------*/
(
/*------------------------------------------------------------------------------------------------------------------------*/
   SELECT 
          *
                                                               FROM [forum].[dbo].[Pew_Answer_NoStd]                          -->    30,423
/*------------------------------------------------------------------------------------------------------------------------*/
                                                                                                            ) PewAnsNoStdT
/*------------------------------------------------------------------------------------------------------------------------*/
ON
       [Ans_fk]               
     = [Answer_pk]
/*------------------------------------------------------------------------------------------------------------------------*/  --> 2,360,156
/* <   .  check consistency of Country/Religion/Province/Individual data linked to answers ********************************/
/**************************************************************************************************************************/
/**************************************************************************************************************************/
/**************************************************************************************************************************/
/* >   .  delete Country-Religion data linked to old answers to GSI & AFR *************************************************/
/*------------------------------------------------------------------------------------------------------------------------*/
--	DELETE                                             PNRA                    /* deletion statement!                     */
/*------------------------------------------------------------------------------------------------------------------------*/
--	SELECT *                                                                   /* start TEST from this statement...       */
/*------------------------------------------------------------------------------------------------------------------------*/
  FROM                                                                         /*                                         */
       [forum].[dbo].[Pew_Nation_Religion_Answer]      PNRA                    /*                                         */
/*------------------------------------------------------------------------------------------------------------------------*/
INNER JOIN
/*------------------------------------------------------------------------------------------------------------------------*/
       [forum].[dbo].[Pew_Answer_NoStd]                                        /* TEST old number of rows...              */
/*------------------------------------------------------------------------------------------------------------------------*/
ON                                                                             /*                                         */
       [Answer_fk]                                                             /*                                         */
     = [Answer_pk]                                                             /*                                         */
/*------------------------------------------------------------------------------------------------------------------------*/  -->    54,556
INNER JOIN                                                                     /*                                         */
/*------------------------------------------------------------------------------------------------------------------------*/
       [forum].[dbo].[Pew_Question_NoStd]                                      /*                                         */
   ON                                                                          /*                                         */
       [Question_fk]                                                           /*                                         */
     = [Question_pk]                                                           /* TEST number of rows linked to QnStd     */
/*------------------------------------------------------------------------------------------------------------------------*/
 WHERE                                                                         /*                                         */
       [Answer_Std_fk] LIKE ( -1 )                                             /* rows NOT linked to AStd                 */  -->     8,721
        and (                                                                  /*                                         */
               Question_abbreviation like 'AFR%'                               /*                                         */
               or                                                              /*                                         */
               Question_abbreviation like 'GSI%'                               /*                                         */
            )                                                                  /* and from old versions of GSI & AFR      */  -->     8,721
/*------------------------------------------------------------------------------------------------------------------------*/
/* >   .  delete Country-Religion data linked to old answers to GSI & AFR *************************************************/
