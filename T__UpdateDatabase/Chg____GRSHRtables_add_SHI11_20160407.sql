/***************************************************************************************************************************************************************/
--------Print 
--------'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 000    ------------------------------------------------------------------------------------------ '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>         This script loads SHI_11                                                                                                    <<<<<     ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***      Long set of entered data should include numeric values, standard answers, and descriptive wordings for GR&SH R                                     ***/
/***                                                                                                                                                         ***/
/***         This script updates the database in terms of:                                                                                                   ***/
/***                                                                                                                                                         ***/
/***            - loading NoStd Q SHI_11 for 2014                                                                                                            ***/
/***                                                                                                                                                         ***/
/***            - loading NoStd Answers to be added to:                                                                                                      ***/
/***                      [Pew_Answer_NoStd]                                                                                                                 ***/
/***                                                                                                                                                         ***/
/***            - loading 'çountry-level' answers to be added to:                                                                                            ***/
/***                      [Pew_Nation_Answer]                                                                                                                ***/
/***                      [Pew_Nation_Religion_Answer]                                                                                                       ***/
/***                      [Pew_Locality_Answer])                                                                                                             ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE [_bk_forum]
GO
/***************************************************************************************************************************************************************/
/***                 rename BACKUP                                                                                                                           ***/
/***************************************************************************************************************************************************************/
  DECLARE  @CrDt    varchar( 8)
  DECLARE  @TofI    varchar(50)
  SET      @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
  DECLARE  MyCursor
  CURSOR FOR      SELECT 'Pew_Answer_NoStd'
            UNION SELECT 'Pew_Locality_Answer'
            UNION SELECT 'Pew_Nation_Answer'
            UNION SELECT 'Pew_Nation_Religion_Answer'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
   OPEN    MyCursor
	FETCH  NEXT
	FROM   MyCursor
	INTO   @TofI
	WHILE  @@FETCH_STATUS = 0
	BEGIN
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
--           EXEC ( ' sp_rename   [' + @TofI +          '],
--                                [' + @TofI + '_20160407]  ' )
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
	FETCH  NEXT
	FROM   MyCursor
	INTO   @TofI
    END
    CLOSE  MyCursor
DEALLOCATE MyCursor
/***************************************************************************************************************************************************************/



/***************************************************************************************************************************************************************/
USE [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
--	/***********************************************************************************************************************************************************/
--	/*****     BackUp  current Table                                                                                                                       *****/
--	/***********************************************************************************************************************************************************/
--	  DECLARE @CrDt    varchar( 8)
--	  SET     @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	EXEC ( ' SELECT *
--					INTO  [_bk_forum].[dbo].[Pew_Question_NoStd_' + @CrDt + ']
--					FROM      [forum].[dbo].[Pew_Question_NoStd]'               )
/***************************************************************************************************************************************************************/
--	INSERT INTO               [forum].[dbo].[Pew_Question_NoStd]                                                    /* insert statement into target in main DB */
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	SELECT                                                                                                          /* select statement...                     */
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--		   [Question_pk]           =   1
--									+ (SELECT     MAX([Question_pk])                                                /* add currently max pk                    */
--										FROM [forum]..[Pew_Question_NoStd])                                         /* from NoStdQuestions                     */
--		  ,[Question_abbreviation]
--		  ,[Question_wording]
--		  ,[Question_Year]         =  2014
--		  ,[Notes]                 =  'January - December 2014'
--		  ,[Display]               =  0
--		  ,[Data_source_fk]
--		  ,[Question_Std_fk]
--	FROM
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	   [forum].[dbo].[Pew_Question_NoStd]
--	WHERE  [Question_abbreviation] = 'SHI_11'
--	  AND  [Question_Year]         =  2013
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IF           OBJECT_ID('tempdb..#NDLongNoAggreg')  IS NOT NULL
DROP TABLE                     [#NDLongNoAggreg]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT * INTO                  [#NDLongNoAggreg]
  FROM        (
/*|->  CORRECTED set of coded data ===========================================================================================================================*/
/*    >  ADD SHI_11 - to be calculated from Access Tool next year ============================================================================================*/
		 SELECT
				 [entity]               = 'CR&P'
				,[link_fk]              = 0
				,[Nation_fk]
				,[Locality_fk]          = NULL
				,[Religion_fk]          = NULL
				,[Region5]
				,[Region6]
				,[Ctry_EditorialName]
				,[Locality]             = ''
				,[Religion]             = ''
				,[Question_Year]        = 2014
				,[QA_std]               = 'SHI_11'
				,[QW_std]               = 'Were women harassed for violating religious dress codes?'
                ,[Answer_value]         = CAST(
                                                CASE WHEN SUM([AV]) > 1 THEN 1
                                                     ELSE SUM([AV])                END   AS DECIMAL(38,2))
				,[answer_wording]       = ''
				,[answer_wording_std]   =       CASE WHEN SUM([AV]) = 0 THEN 'No'
                                                                        ELSE 'Yes' END
				,[Question_fk]          = 0
				,[Answer_fk]            = 0
				,[Notes]                = 'January - December 2014'
           FROM
			(	SELECT [AV]  = CASE
								   WHEN [QA_std] = 'SHI_11_a' AND [Answer_value] = 1 THEN 0.5 
                                   ELSE                           [Answer_value]
							   END
					  ,*
                  FROM [GRSHRResults].[dbo].[NDLongNoAggreg]
                 WHERE [QA_std] IN ( 'SHI_11_a', 'SHI_11_b' )                                   ) SHI11
       GROUP BY  [Nation_fk]
				,[Region5]
				,[Region6]
				,[Ctry_EditorialName]
/*    <  ADD SHI_11 - to be calculated from Access Tool next year ============================================================================================*/
/*|<-  CORRECTED set of coded data ===========================================================================================================================*/
              )  CSCD
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IF                    OBJECT_ID('tempdb..#NLongCodedData')  IS NOT NULL
DROP TABLE                              [#NLongCodedData]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT * INTO                           [#NLongCodedData]
  FROM
/*=============================================================================================================================================================*/
(
/*=============================================================================================================================================================*/
SELECT 
/*|->  Final main CODED fields =====================================================================================================================================*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
           [entity]                         =                                                         'C'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*--  >  Fields for PANS from the former coding-period --------------------------------------------------------------------------------------------------------*/
      ,    [Answer_pk]                      =  (DENSE_RANK()
                                                       OVER
                                                  (ORDER BY     CD.[QA_std]
                                                           ,    CD.[Answer_Value]
                                                           ,    CD.[Answer_Wording]    ) )
                                              + (SELECT MAX([Answer_pk])
                                                   FROM [forum].[dbo].[Pew_Answer_NoStd] )
      ,    [Answer_value_NoStd]             =  CD.[Answer_value]
      ,    [Answer_Wording]                 =  CASE
                                               WHEN CD.[Answer_value] =  0.0 THEN 'No'
                                               WHEN CD.[Answer_value] =  0.5 THEN 'No, but religious women were harassed for violating secular norms'
                                               WHEN CD.[Answer_value] =  1.0 THEN 'Yes'
                                               END
      ,    [Answer_Std_fk]                  =  AT.[Answer_Std_pk]
      ,    [Question_fk]                    =  QN.[Question_pk]
/*--  <  Fields for PANS from the former coding-period --------------------------------------------------------------------------------------------------------*/
      ,    [Display]                        =                                                                   1
      , CD.[Nation_fk]
      , CD.[Region5]
      , CD.[Region6]
      , CD.[Ctry_EditorialName]
      , CD.[Question_Year]
      , CD.[QA_std]
      , CD.[QW_std]
      ,    [Answer_value]      =  CAST(CD.[Answer_value]   AS DECIMAL(38,2))
      , CD.[answer_wording_std]
      , CD.[Notes]
      , QT.[Question_Std_pk]
      , QT.[AnswerSet_num]
  FROM
/* TABLES section begins ======================================================================================================================================*/
/*|->  Clean set of coded data ================================================================================================================================*/
(
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
 SELECT *
   FROM
/*--  >  Set of data from the former coding-period ------------------------------------------------------------------------------------------------------------*/
--      [GRSHRResults].[dbo].[NDLongNoAggreg]
                             [#NDLongNoAggreg]   -----  when data has been corrected
/*--  <  Set of data from the former coding-period ------------------------------------------------------------------------------------------------------------*/
)                                                  CD
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*|<-  Clean set of coded data ================================================================================================================================*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
 INNER
 JOIN 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*|->  Set of =================================================================================================================================================*/
       [forum].[dbo].[Pew_Question_Std]            QT
   ON 
      CD.[QA_std]
    = QT.[Question_abbreviation_std]
/*|<-  Set of =================================================================================================================================================*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
 INNER
 JOIN 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*|->  Set of =================================================================================================================================================*/
       [forum].[dbo].[Pew_Answer_Std]              AT
   ON 
      QT.[AnswerSet_num]
    = AT.[AnswerSet_number]
  AND
      CASE WHEN QT.[AnswerSet_num] = 999999
            AND CD.[Answer_value]  > 1      THEN 1     
           ELSE CD.[Answer_value]
      END
    = AT.[Answer_value_std]
/*|<-  Set of =================================================================================================================================================*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
 INNER
 JOIN 
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*|->  Set of =================================================================================================================================================*/
       [forum].[dbo].[Pew_Question_NoStd]            QN
   ON 
      CD.[QA_std]
    = QN.[Question_abbreviation]
  AND
      CD.[Question_Year]
    = QN.[Question_Year]
/*|<-  Set of NoStd Questions =================================================================================================================================*/
/* TABLES section ends ========================================================================================================================================*/
/*|<-  Final main CODED fields =====================================================================================================================================*/
/*=============================================================================================================================================================*/
) source_for_loading_data
/*=============================================================================================================================================================*/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/












/***************************************************************************************************************************************************************/
/***                 BACKUP                                                                                                                             ***/
/***************************************************************************************************************************************************************/
  DECLARE  @CrDt    varchar( 8)
  DECLARE  @TofI    varchar(50)
  SET      @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
  DECLARE  MyCursor
  CURSOR FOR      SELECT 'Pew_Answer_NoStd'
            UNION SELECT 'Pew_Locality_Answer'
            UNION SELECT 'Pew_Nation_Answer'
            UNION SELECT 'Pew_Nation_Religion_Answer'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
   OPEN    MyCursor
	FETCH  NEXT
	FROM   MyCursor
	INTO   @TofI
	WHILE  @@FETCH_STATUS = 0
	BEGIN
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
           EXEC ( ' SELECT *
                    INTO   [_bk_forum].[dbo].[' + @TofI + '_' + @CrDt + ']
                    FROM       [forum].[dbo].[' + @TofI + ']' )
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
	FETCH  NEXT
	FROM   MyCursor
	INTO   @TofI
    END
    CLOSE  MyCursor
DEALLOCATE MyCursor
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Answer_NoStd]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT
           DISTINCT
           [Answer_pk]
         , [Answer_value_NoStd]
         , [Answer_Wording]
         , [Answer_Std_fk]
         , [Question_fk]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
FROM   [#NLongCodedData]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Nation_Answer]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SELECT
/*--  >  Fields for PNA from the former coding-period ---------------------------------------------------------------------------------------------------------*/
       [Nation_answer_pk]    = ROW_NUMBER()
                                       OVER
                                  (ORDER BY   [Nation_fk]
                                            , [QA_Std]              )
                              +   (SELECT MAX([Nation_answer_pk]    )
                                FROM [forum]..[Pew_Nation_Answer]   )
      ,[Nation_fk]
      ,[Answer_fk]           = [Answer_pk]
      ,[display]
/*--  <  Fields for PNA from the former coding-period ---------------------------------------------------------------------------------------------------------*/
FROM   [#NLongCodedData]
WHERE  [entity]              = 'C'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
--		C      198
/***************************************************************************************************************************************************************/
