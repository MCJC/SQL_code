/**************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 000_a  - stored prtocedure    ------------------------------------------------------ '
/**************************************************************************************************************************************************/
/***                                                                                                                                            ***/
/***     >>>>>         This stored procedure script creates long set of data from the 'Global Restriction on Religion Study'                           <<<<<     ***/
/***                   The long set of data includes numeric values and descriptive wordings for GR&SH R                                        ***/
/***                                                                                                                                            ***/
/**************************************************************************************************************************************************/
USE [forum_ResAnal]
GO
/**************************************************************************************************************************************************/
	DROP PROC ExtractGRSH
	GO
/**************************************************************************************************************************************************/
  CREATE PROC ExtractGRSH
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
                        @level        nvarchar(4)
                      , @tname        nvarchar(max)
                      , @NEWTB        nvarchar(max)
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
AS
/**************************************************************************************************************************************************/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
----declare                 @level        nvarchar(4)
----declare                 @tname        nvarchar(max)
----declare                 @NEWTB        nvarchar(max)
----set                     @level      = 'Ctry'                 --  'Prov'                   --  'RGrp'                          --  
----set                     @tname      = '[Pew_Nation_Answer]'  --  '[Pew_Locality_Answer]'  --  '[Pew_Nation_Religion_Answer]'  --  
----set                     @NEWTB      = '[#NewTempTab]'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/**************************************************************************************************************************************************/
declare @ALLCODE nvarchar(max)
set     @ALLCODE = 
/**************************************************************************************************************************************************/
/*** Selection statement for sets of data at country, country/religion or country/province levels *************************************************/
N'
SELECT
        [entity]                 =   ''' + @level + '''
      , [QA_fk]                  =   Q.[QA_pk]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*  >   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
 ( SELECT [v3]                     = CASE WHEN @level  = 'Ctry' THEN '      , [link_fk]                =   K.[Nation_answer_pk]'
                                          WHEN @level  = 'RGrp' THEN '      , [link_fk]                =   K.[Nation_religion_answer_pk]'
                                          WHEN @level  = 'Prov' THEN '      , [link_fk]                =   K.[Locality_answer_pk]'           END  )
/*  <   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
      , [Nation_fk]              =   N.[Nation_pk]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*  >   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
 ( SELECT [v4]                     = CASE WHEN @level  = 'Prov' THEN '      , [Locality_fk]            =   L.[Locality_pk]'
                                          WHEN @level != 'Prov' THEN '      , [Locality_fk]            =   '''''                             END  )
/*  <   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*  >   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
 ( SELECT [v5]                     = CASE WHEN @level  = 'RGrp' THEN '      , [Religion_fk]            =   G.[Religion_group_pk]'
                                          WHEN @level != 'RGrp' THEN '      , [Religion_fk]            =   '''''                             END  )
/*  <   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
      , [Region5]                =   N.[Region]
      , [Region6]                =   N.[SubRegion6]
      , [Ctry_EditorialName]     =   N.[Ctry_EditorialName]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*  >   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
 ( SELECT [v4]                     = CASE WHEN @level  = 'Prov' THEN '      , [Locality]               =   L.[Locality]'
                                          WHEN @level != 'Prov' THEN '      , [Locality]               =   '''''                             END  )
/*  <   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*  >   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
 ( SELECT [v5]                     = CASE WHEN @level  = 'RGrp' THEN '      , [Religion]               =   G.[Pew_religion]'
                                          WHEN @level != 'RGrp' THEN '      , [Religion]               =   '''''                             END  )
/*  <   Selection statement to include field -----------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
      , [Question_Year]          =   Q.[Question_Year]
      , [QA_std]                 =   Q.[Question_abbreviation_std]
      , [QW_std]                 =   Q.[Question_short_wording_std]
      , [Answer_value]           =   Q.[Answer_value]
      , [Answer_value_Std]       =   Q.[Answer_value_Std]
      , [Answer_value_NoStd]     =   Q.[Answer_value_NoStd]
      , [answer_wording]         =   Q.[answer_wording]
      , [answer_wording_std]     =   Q.[answer_wording_std]
      , [Data_source_name]       =   Q.[Data_source_name]
      , [Question_Std_fk]        =   Q.[Question_Std_fk]
      , [Question_fk]            =   Q.[Question_fk]
      , [Answer_Std_fk]          =   Q.[Answer_Std_fk]
      , [Answer_fk]              =   Q.[Answer_fk]
      , [AnswerSet_number]       =   Q.[AnswerSet_number]
      , [Question_wording_std]   =   Q.[Question_wording_std]
      , [Question_wording]       =   Q.[Question_wording]
      , [Question_abbreviation]  =   Q.[Question_abbreviation]
      , [NA_by_set_of_Answers]   =   Q.[NA_by_set_of_Answers]
      , [Full_set_of_Answers]    =   Q.[Full_set_of_Answers]
      , [Display_by_StdQ]        =   Q.[Display]
      , [Display_by_NoSQ]        =   Q.[Display_NoStd]
      , [Display_by_Ans]         =   K.[Display]
      , [Editorially_Checked]    =   Q.[Editorially_Checked]
      , [Notes]                  =   Q.[Notes]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'  INTO ' + @NEWTB + ' '
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/



/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
  FROM [forum].[dbo].[Pew_Q&A]                      Q
      ,[forum].[dbo].[Pew_Nation]                   N
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*** >  Selection statement to select TABLES TO BE INCLUDED in the query **************************************************************************/
       (   SELECT [TABLE3n4]      = CASE WHEN     @level     =   'Ctry'  THEN   '      ,              '  + @tname +     '            K'
                                         WHEN     @level     =   'RGrp'  THEN   '      ,              '  + @tname +              '   K'
                                                                   + CHAR(10) + '      ,[forum].[dbo].[Pew_Religion_Group]           G'
                                         WHEN     @level     =   'Prov'  THEN   '      ,              '  + @tname +       '          K'
                                                                   + CHAR(10) + '      ,[forum].[dbo].[Pew_Locality]                 L'
                                    END                                                                                                      )
/*** <  Selection statement to select TABLES TO BE INCLUDED in the query **************************************************************************/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
    WHERE Q.[Answer_fk]           = K.[Answer_fk]
      AND Q.[Pew_Data_Collection] = ''Global Restriction on Religion Study''
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*** >  Selection statement to include link for TABLES besides main answer key ********************************************************************/
       (   SELECT [LINK3]         = CASE WHEN     @level     =   'Ctry'  THEN   ''
                                         WHEN     @level     =   'RGrp'  THEN   '      AND K.[Religion_group_fk]    =  G.[Religion_group_pk]'
                                         WHEN     @level     =   'Prov'  THEN   '      AND K.[Locality_fk]          =  L.[Locality_pk]      '
                                    END                                                                                                       )
/*** <  Selection statement to include link for TABLES besides main answer key ********************************************************************/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*** >  Selection statement to include link at national level for data previously used for Northern Cyprus ****************************************/
       (   SELECT [LINK4]         = CASE WHEN     @level     =   'Prov'  THEN   '      AND N.[Nation_pk]           =                           '
                                                                   + CHAR(10) + '                                CASE                           '
                                                                   + CHAR(10) + '                                 WHEN L.[Nation_fk]     = 237  '
                                                                   + CHAR(10) + '                                  AND Q.[Question_Year] < 2010 '
                                                                   + CHAR(10) + '                                 THEN     197                  '
                                                                   + CHAR(10) + '                                 ELSE L.[Nation_fk]            '
                                                                   + CHAR(10) + '                                END                            '
                                         ELSE                                   '      AND K.[Nation_fk]           =  N.[Nation_pk]         '
                                    END                                                                                                           )
/*** <  Selection statement to include link at national level for data previously used for Northern Cyprus ****************************************/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
SELECT * FROM ' + @NEWTB + '
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** Selection statement for sets of data at country, country/religion or country/province levels *************************************************/
/**************************************************************************************************************************************************/
/*** checking / executing SQL statement that has been stored as a string variable *****************************************************************/
--	EXEC dbo.LongPrint @ALLCODE                        /***        display the currently stored code (to be executed)                           ***/
	EXEC              (@ALLCODE)                       /***        execute the code that has been stored as text                                ***/
/**************************************************************************************************************************************************/

/**************************************************************************************************************************************************/
GO
/**************************************************************************************************************************************************/




--ExtractGRSH 'Ctry', '[FORUM]..[Pew_Nation_Answer]'         , '[#NewTempTab1]'
--GO 
--ExtractGRSH 'Prov', '[FORUM]..[Pew_Locality_Answer]'       , '[#NewTempTab2]'
--GO 
--ExtractGRSH 'RGrp', '[FORUM]..[Pew_Nation_Religion_Answer]', '[#NewTempTab1]'
--GO 
