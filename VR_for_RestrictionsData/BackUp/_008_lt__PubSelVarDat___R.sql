/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 008    ------------------------------------------------------------------------------------------ '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the lookup table [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]                         <<<<<     ***/
/***             This table filters selected values from [vr___03_cDB_W&Xtra_byCtry&Year] aggregated by country/religion & year                              ***/
/***             The data will be available for public download                                                                                              ***/
/***                                                                                                                                                         ***/
/***                                                      > > >     lookup tables work faster     < < <                                                      ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
declare @ALLCODE nvarchar(max)
/***************************************************************************************************************************************************************/
set     @ALLCODE = 
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
ALTER  VIEW                      [dbo].[vrp__01_]        AS
SELECT * FROM
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'(
   SELECT
          [Nation_fk]
         ,[Region5]
         ,[Region6]
         ,[Ctry_EditorialName]
         ,[Question_Year]
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** Begin selection (into text, in a cell) of a comma delimited list of fields from joined tables *************************************************************/
/***************************************************************************************************************************************************************/
(                                                                               /*** parenthesis to include query for the cell to be stuffed                 ***/
    SELECT                                                                      /*** SELECT statement                                                        ***/
                ', ['                                                           /*** comma delimiter & bracet                                                ***/
              + Q.[attr]                                                        /*** concatenated to Q Attr for Pulic Set Q name                             ***/
              + ']   =   ['                                                     /*** concatenated to bracets and equal sign                                  ***/
              + S.[Question_Abbreviation_Std]                                   /*** concatenated to Q Abbr Std                                              ***/
              + CASE                                                            /*** concatenated to the beginning of case clause                            ***/
			         WHEN             C.[attr] IS NOT NULL                      /*** concatenated to condition attrib of scale exists                        ***/
				     THEN ']   *  ' + C.[attr]                                  /*** concatenated to value of the attribute                                  ***/
                     ELSE ']'                                                   /*** concatenated to string for all other cases                              ***/
                 END                                                            /*** concatenated to the endof case clause                                   ***/
    FROM                                                                        /*** from...                                                                 ***/
                          [forum]..[Pew_Question_Std]                S          /*** Std Q is the first joined table, which includes Q names as rows         ***/
  INNER JOIN                                                                    /*** (inner) joined to...                                                    ***/
          ( SELECT * FROM [forum]..[Pew_Question_Attributes]                    /*** Q Attribs is first joined in order to...                                ***/
                    WHERE [attk] = 'In_PubDataSet'   )      Q                   /***                       ... select variables and get public names ,,,     ***/
     ON      S.[Question_Std_pk] = Q.[Question_Std_fk]                          /***                       ... by merging pk/fk                              ***/
   LEFT JOIN                                                                    /*** (left) joined to...                                                     ***/
          ( SELECT * FROM [forum]..[Pew_Question_Attributes]                    /*** Q Attribs is also joined in order to...                                 ***/
                    WHERE [attk] = 'PubDS_scale'     )      C                   /***                       ... include re-scaling values                     ***/
     ON      S.[Question_Std_pk] = C.[Question_Std_fk]                          /***                       ... by merging pk/fk                              ***/
   LEFT JOIN                                                                    /*** (left) joined to...                                                     ***/
          ( SELECT * FROM [forum]..[Pew_Question_Attributes]                    /*** Q Attribs is also joined in order to...                                 ***/
                    WHERE [attk] = 'PubDS_sort'      )      O                   /***                       ... include Q sorting order                       ***/
     ON      S.[Question_Std_pk] = O.[Question_Std_fk]                          /***                       ... by merging pk/fk                              ***/
   ORDER BY  O.[attr]                                                           /*** sorting order using the linked value                                    ***/
         for xml path('')                                                       /*** Modifies the selected rowset nesting all cells into an XML string cell  ***/
)                                                                               /*** parenthesis to include query for the cell to be stuffed                 ***/
/***************************************************************************************************************************************************************/
/*************************************************************************** End of the selection (into text, in a cell) of a comma delimited list of fields ***/
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*--- > source dataset ----------------------------------------------------------------------------------------------------------------------------------------*/
N'
FROM
                 [forum_ResAnal].[dbo].[vr___03_cDB_W&Xtra_byCtry&Year]
'
/*--- < source dataset ----------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*=============================================================================================================================================================*/
N') SelPubDS '                                                                  /*** CLOSE parenthesis including the whole query for the view                ***/
/***************************************************************************************************************************************************************/
/*** checking / executing SQL statement that has been stored as a string variable ******************************************************************************/
--	EXEC dbo.LongPrint @ALLCODE                                                 /***        display the currently stored code (to be executed)               ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	EXEC              (@ALLCODE)                                                /***        execute the code that has been stored as text                    ***/
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/








/***************************************************************************************************************************************************************/
IF OBJECT_ID  (N'[forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]', N'U') IS NOT NULL
DROP TABLE       [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]
            FROM                 [dbo].[vrp__01_]
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/
--	SELECT* FROM [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]
/***************************************************************************************************************************************************************/
