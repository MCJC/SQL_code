/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 009    ------------------------------------------------------------------------------------------ '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the lookup table [forum_ResAnal].[dbo].[vrp__01_lab_SelDataBYCtry&Year]                         <<<<<     ***/
/***             This table has Stata statements for labeling variables included in dataset for public download                                              ***/
/***                                                                                                                                                         ***/
/***                                                      > > >     lookup tables work faster     < < <                                                      ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ALTER  VIEW                      [dbo].[vrp__01v]        AS
SELECT
 	   [k]           =  ROW_NUMBER() OVER(ORDER BY [k])
	 , [rowforlabel] 
  FROM
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
   SELECT
 	    [k]           =                                                  N.[attr]
	  , [rowforlabel] = 
	                       'label var  ' 
                        +                                                Q.[attr]
                        +  RIGHT('                           "', (33-LEN(Q.[attr])))
                        +                                                L.[attr]
                        +  '"  '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    FROM
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                          [forum]..[Pew_Question_Std]                S 
  INNER JOIN
             ( SELECT * FROM [forum]..[Pew_Question_Attributes] WHERE [attk] = 'In_PubDataSet' )   Q    ON S.[Question_Std_pk] = Q.[Question_Std_fk]
   LEFT JOIN
             ( SELECT * FROM [forum]..[Pew_Question_Attributes] WHERE [attk] = '80CharsLabel'  )   L    ON S.[Question_Std_pk] = L.[Question_Std_fk]
   LEFT JOIN
             ( SELECT * FROM [forum]..[Pew_Question_Attributes] WHERE [attk] = 'PubDS_sort'    )   N    ON S.[Question_Std_pk] = n.[Question_Std_fk]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/

UNION ALL

/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
             SELECT
 	    [k]           =    994
	  , [rowforlabel] =   'note:  Please NOTE that variable notes list decoded values for each variable of this dataset'
   UNION ALL SELECT
 	    [k]           =    995
	  , [rowforlabel] =   'note Nation_fk:  Principal code key (numeric) for '
                         + CAST((SELECT COUNT(DISTINCT Nation_fk) FROM [vrp__01_]) AS VARCHAR(3))
                         + ' countries'
   UNION ALL SELECT
 	    [k]           =    996
	  , [rowforlabel] =   'note Region5:  Five regions: '
                         + (SELECT STUFF((SELECT DISTINCT ', ' + [Region5] FROM [vrp__01_]
                                                 ORDER BY ', ' + [Region5] FOR XML PATH('')),1,2,''))
   UNION ALL SELECT
 	    [k]           =    997
	  , [rowforlabel] =   'note Region6:  Six regions: '
                         + (SELECT STUFF((SELECT DISTINCT ', ' + [Region6] FROM [vrp__01_]
                                                 ORDER BY ', ' + [Region6] FOR XML PATH('')),1,2,''))
   UNION ALL SELECT
 	    [k]           =    998
	  , [rowforlabel] =   'note Ctry_EditorialName:  '
                         + CAST((SELECT COUNT(DISTINCT Nation_fk) FROM [vrp__01_]) AS VARCHAR(3))
                         + ' countries'
   UNION ALL SELECT
 	    [k]           =    999
	  , [rowforlabel] =   'note Question_Year:  Years od data included, from '
                         + CAST((SELECT MIN(Question_Year) FROM [vrp__01_]) AS VARCHAR(4))
                         + ' to '
                         + CAST((SELECT MAX(Question_Year) FROM [vrp__01_]) AS VARCHAR(4))
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/

UNION ALL

/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
   SELECT
 	    [k]           =   1000 + ROW_NUMBER() OVER(ORDER BY Q.[attr], [Answer_value_std])
	  , [rowforlabel] =   'note ' + Q.[attr] + ':   ' + Cast([Answer_value_std] as varchar(4)) + '   '+ [Answer_Wording_std]
  FROM [forum].[dbo].[Pew_Q&A_Std]                                                                   S
  INNER JOIN
             ( SELECT * FROM [forum]..[Pew_Question_Attributes] WHERE [attk] = 'In_PubDataSet' )   Q    ON S.[Question_Std_fk] = Q.[Question_Std_fk]







)  SETA
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/




/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/








/***************************************************************************************************************************************************************/
IF OBJECT_ID  (N'[forum_ResAnal].[dbo].[vrp__01v_labSelDataBYCtry&Year]', N'U') IS NOT NULL
DROP TABLE       [forum_ResAnal].[dbo].[vrp__01v_labSelDataBYCtry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vrp__01v_labSelDataBYCtry&Year]
            FROM                 [dbo].[vrp__01v]
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/
--	SELECT* FROM [forum_ResAnal].[dbo].[vrp__01_lab_SelDataBYCtry&Year]
/***************************************************************************************************************************************************************/
