/**************************************************************************************************************************************************/
/***                                                                                                                                            ***/
/***     >>>>>   This is the script used to create the view [GRSHRYYYY].[dbo].[v05_ReportData]                                        <<<<<     ***/
/***             (values and descriptions for current & former coding years - in long format by country & variable)                             ***/
/***                                                                                                                                            ***/
/**************************************************************************************************************************************************/
/*                                                                                                                                                */
/*  REFERENCE to 2015 appears JUST ONCE in the script                                                                                             */
/*                                                                                                                                                */
/**************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==> creating view [v05_ReportData]                                                           --- '
/**************************************************************************************************************************************************/
USE              [GRSHRcode]
GO




/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> these are the variables to be used                                        ***/
/**************************************************************************************************************************************************/
declare @CURR nvarchar(10)                                /***        declare variable for storing current year (as text)                       ***/
set     @CURR = (SELECT DISTINCT [Question_Year]          /***        set text value to current year                                            ***/
                 FROM [v02_AllCodedValues]                /***        from main view used as source                                             ***/
                 WHERE  [Q_Yr] = ( (SELECT MAX([Q_Yr])    /***        filtered using max numeric year value                                     ***/
                        FROM [v02_AllCodedValues]) - 0 )) /***        from the same main view used as source  (as the value is)                 ***/
declare @NCUR nvarchar(4)                                 /***        declare variable for storing current year (as text)                       ***/
set     @NCUR = (SELECT DISTINCT CAST([Q_Yr] AS NVARCHAR) /***        set value to current year                                                 ***/
                 FROM [v02_AllCodedValues]                /***        from main view used as source                                             ***/
                 WHERE  [Q_Yr] = ( (SELECT MAX([Q_Yr])    /***        filtered using max numeric year value                                     ***/
                        FROM [v02_AllCodedValues]) - 0 )) /***        from the same main view used as source  (as the value is)                 ***/
declare @PAST nvarchar(10)                                /***        declare variable for storing former year (as text)                        ***/
set     @PAST = (SELECT DISTINCT [Question_Year]          /***        set text value to past year (from current year)                           ***/
                 FROM [v02_AllCodedValues]                /***        from main view used as source                                             ***/
                 WHERE  [Q_Yr] = ( (SELECT MAX([Q_Yr])    /***        filtered using max numeric year value                                     ***/
                        FROM [v02_AllCodedValues]) - 1 )) /***        from the same main view used as source  (minus one for former year)       ***/
declare @NPAS nvarchar(4)                                 /***        declare variable for storing former year (as text)                        ***/
set     @NPAS = (SELECT DISTINCT CAST([Q_Yr] AS NVARCHAR) /***        set value to past year (from current year)                                ***/
                 FROM [v02_AllCodedValues]                /***        from main view used as source                                             ***/
                 WHERE  [Q_Yr] = ( (SELECT MAX([Q_Yr])    /***        filtered using max numeric year value                                     ***/
                        FROM [v02_AllCodedValues]) - 1 )) /***        from the same main view used as source  (minus one for former year)       ***/
/**************************************************************************************************************************************************/
declare @CODEmain nvarchar(max)                           /***        declare variable for storing the main code to be executed                 ***/
set     @CODEmain =                                       /***        start storing text as part of the main code to be executed                ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< these have been the variables to be used                                  ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> this is the code to be executed                                           ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 1 of the code: main select statement                         ***/
/**************************************************************************************************************************************************/
N'
ALTER VIEW     [v05_ReportData]
AS

SELECT
       [Nation_fk]
      ,[Ctry_EditorialName]
      ,[Variable]            =  [QA_std]
      ,[Change]              =  [AnswerNewVal]
	                          - [Answer_value]
      ,   [AnswerNewVal]        AS Value_' + @CURR + '
      ,   [AnswWordStdN]        AS Wrdng_' + @CURR + '
      ,   [AnswNewWordg]        AS Descr_' + @CURR + '
      ,   [Answer_value]        AS Value_' + @PAST + '
      ,   [answer_wording_std]  AS Wrdng_' + @PAST + '
      ,   [answer_wording]      AS Descr_' + @PAST + '
  FROM
'
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 1 of the code: main select statement                   ***/
/**************************************************************************************************************************************************/
+
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 2 of the code: select data of last year & added vars         ***/
/**************************************************************************************************************************************************/
N'
(  SELECT 
          [Nation_fk]
        , [Ctry_EditorialName]
        , [QA_std]
        , [Answer_value]        = NULL
        , [answer_wording]      = ''''
        , [answer_wording_std]  = ''''
     FROM [AllLongData]
    WHERE [Question_Year] = ' + @Ncur + '
     AND  [DB]            = 0
UNION
ALL  
   SELECT 
          [Nation_fk]
        , [Ctry_EditorialName]
        , [QA_std]
        , [Answer_value]
        , [answer_wording]
        , [answer_wording_std]
     FROM [AllLongData]
    WHERE [Question_Year] = ' + @NPAS + '                                                                                     )  [LastYr]
'
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 2 of the code: select data of last year & added vars   ***/
/**************************************************************************************************************************************************/
+
N'LEFT JOIN  '                                            /***        MAIN join statement                                                       ***/
+
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 3 of the code: select data of current year                   ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>   this is part 3.1.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
(  SELECT
          [V_Nfk]         = [Nation_fk]
         ,[V_VAR]
         ,[AnswerNewVal]
         ,[AnswNewWordg]
         ,[AnswWordStdN]  = [Answer_wording_std]
     FROM
         ( SELECT *
             FROM [v02_AllCodedValues]
            WHERE [Q_Yr] = ' + @NCUR + ' )  [YrVals]
          unpivot ([AnswerNewVal]
              for  [V_VAR]
               in (
                   '
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.1.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+   STUFF( (                                              /*** >>     stuff function & parenthesis for query XML cell to be stuffed             ***/
          SELECT                                          /*** >      Begin selection (into text, in a cell, comma delimited list)              ***/
                    ', ' + [WQA_std]                      /***        distinct comma delimiter concatenated to field QA (as varname)            ***/
          FROM      [WT_VNs]                              /***        from table including var names & classifications as rows                  ***/
          WHERE     [QClass]     IN (   'CODED'           /***        include Q with coded answers                                              ***/
                                      , 'COUNT'           /***        include Q with count answers                                              ***/
                                      , 'PERSI'  )        /***        and include Q with answers automatically calculated                       ***/
            AND     [QTools] NOT IN (   'filter'  )       /***        vars to be excluded: filter questions (usually coded)                     ***/
             FOR XML PATH('')                             /*** <      End of selection, nesting all cells into an XML string cell               ***/
                               ),1, 1, '')                /*** <<     stuff from position 1, change 1st comma into ''                           ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.1.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
                  ) )AS LongVals
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
N'   LEFT JOIN  '                                         /***        join statement                                                            ***/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
(  SELECT
          [D_Nfk]         = [Nation_fk]
         ,[D_VAR]         = REPLACE([Variable],''_DES'','''')
         ,[AnswNewWordg]
     FROM
         ( SELECT *
             FROM [v02_AllCodedValues]
            WHERE [Q_Yr] = ' + @NCUR + ' )  [YrDVal]
          unpivot ([AnswNewWordg]
              for  [Variable]
               in (
                   '
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
    STUFF( (                                              /*** >>     stuff function & parenthesis for query XML cell to be stuffed             ***/
          SELECT                                          /*** >      Begin selection (into text, in a cell, comma delimited list)              ***/
                    ', ' + [WQA_std]                      /***        distinct comma delimiter concatenated to field QA (as varname)            ***/
          FROM      [WT_VNs]                              /***        from table including var names & classifications as rows                  ***/
          WHERE     [QClass]     IN (   'DESCR'  )        /***        include Q with descriptive answers                                        ***/
            AND     [QTools] NOT IN (   'prevyr'  )       /***        vars to be excluded: descriptions used for the previous year              ***/
             FOR XML PATH('')                             /*** <      End of selection, nesting all cells into an XML string cell               ***/
                               ),1, 1, '')                /*** <<     stuff from position 1, change 1st comma into ''                           ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
                  ) )AS LongDescr  ) LD
    ON    [D_Nfk] = [Nation_fk]
    AND   [D_VAR] = [V_VAR]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+
N'   LEFT JOIN  '                                         /***        join statement                                                            ***/
+
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.3 of the code                                              ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
   [All_Answers]
    ON    [V_VAR]        =  [Question_abbreviation_std]
    AND   [AnswerNewVal] =  [Answer_value]
                                                                                                                             ) [MyNewVals]
    ON    [V_Nfk] = [Nation_fk]
    AND   [V_VAR] = [QA_std]
'
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.3 of the code                                              ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 3 of the code: select data of current year             ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< this has been the code to be executed                                     ***/
/**************************************************************************************************************************************************/


/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> statements to display/execute code stored in the variable @CODEmain       ***/
/**************************************************************************************************************************************************/
--	EXEC dbo.LongPrint @CODEmain                          /***        display the currently stored code (to be executed)                        ***/
	EXEC              (@CODEmain)                         /***        execute the code that has been stored as text                             ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< statements to display/execute code stored in the variable @CODEmain       ***/
/**************************************************************************************************************************************************/
GO
