/**************************************************************************************************************************************************/
/***                                                                                                                                            ***/
/***     >>>>>   This is the script used to create the view [GRSHRYYYY].[dbo].[v01_EnteredValues]                                     <<<<<     ***/
/***             (all new currently enetered values)                                                                                            ***/
/***                                                                                                                                            ***/
/**************************************************************************************************************************************************/
/*                                                                                                                                                */
/*  REFERENCE to 2015 appears JUST ONCE in the script                                                                                             */
/*                                                                                                                                                */
/**************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==> creating view [v01_EnteredValues]                                                        --- '
/**************************************************************************************************************************************************/
USE              [GRSHR2015]
GO
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
IF OBJECT_ID  ('tempdb..#vars')                        IS NOT NULL
DROP TABLE              #vars
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
/***  view [EnteredValues] ************************************************************************************************************************/
/**************************************************************************************************************************************************/
declare @CODEnew nvarchar(max)
set     @CODEnew = 
/**************************************************************************************************************************************************/
                                                       /*** >>>    ...                                                                          ***/
 N'
ALTER VIEW     [v01_EnteredValues]
AS
      SELECT
               [RowID]
             , [Question_Year]
             , [Nation_fk]
             , [Ctry_EditorialName]
             ' +
/**************************************************************************************************************************************************/
(           SELECT ', ' + [WQA_std] FROM [WT_VNs]      /*** >      Begin selection (into text, in a cell, comma delimited list of varnames)     ***/
          ORDER BY        [WQA_std]                    /***        keep alphabetical order of fields in the selection                           ***/
                             FOR XML PATH('')    )     /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/**************************************************************************************************************************************************/
+N'
                   FROM [GRI_Ctry]   G
          INNER JOIN
        ( SELECT 
                   [N_fk] = [Nation_fk]
                 ' +
/**************************************************************************************************************************************************/
      (    SELECT ', ' + [WQA_std] FROM [WT_VNs]       /*** >      Begin selection (into text, in a cell, comma delimited list of varnames)     ***/
            WHERE        [QTable]  = 'SH'              /***        include SH* variables (also persisted field)                                 ***/
                         FOR XML PATH('')       )      /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/**************************************************************************************************************************************************/
+N'
                   FROM [SHI_Ctry] ) S
          ON          G.[Nation_fk] 
                   =  S.[N_fk]
          INNER JOIN
        ( SELECT 
                   [N_fk] = [Nation_fk]
                 ' +
/**************************************************************************************************************************************************/
      (    SELECT ', ' + [WQA_std] FROM [WT_VNs]       /*** >      Begin selection (into text, in a cell, comma delimited list of varnames)     ***/
            WHERE        [QTable]  = 'xs'              /***        include xs* variables                                                        ***/
                         FOR XML PATH('')       )      /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/**************************************************************************************************************************************************/
+N'
                   FROM [Sources] ) X
          ON          G.[Nation_fk] 
                   =  X.[N_fk]
                 '
                                                       /*** <<<    ...                                                                          ***/
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
--	EXEC dbo.LongPrint @CODEnew                        /***        display the currently stored code (to be executed)                           ***/
	EXEC              (@CODEnew)                       /***        execute the code that has been stored as text                                ***/
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
GO

