/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the view [V7_LRestr_by_VarVal]                                                                  <<<<<     ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
USE [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
ALTER  VIEW
               [dbo].[V7_LRestr_by_VarVal]
AS
/***************************************************************************************************************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***  Begining of select statement (values by country/year/question)  ******************************************************************************************/

/***************************************************************************************************************************************************************/
SELECT
          V5Row
          =  ROW_NUMBER()
             OVER(ORDER BY
                             [Variable]
                           , [Value]
                                          )
        , Variable
        , Value
        , [NC_MID-2007]   =  STR(MAX([NC_MID-2007]),12,0)
        , [PC_MID-2007]   =  STR(MAX([PC_MID-2007]),3,0)
        , [NC_MID-2008]   =  STR(MAX([NC_MID-2008]),12,0)
        , [PC_MID-2008]   =  STR(MAX([PC_MID-2008]),3,0)
        , [NC_MID-2009]   =  STR(MAX([NC_MID-2009]),12,0)
        , [PC_MID-2009]   =  STR(MAX([PC_MID-2009]),3,0)
        , [NC_MID-2010]   =  STR(MAX([NC_MID-2010]),12,0)
        , [PC_MID-2010]   =  STR(MAX([PC_MID-2010]),3,0)
        , [NC_END-2011]   =  STR(MAX([NC_END-2011]),12,0)
        , [PC_END-2011]   =  STR(MAX([PC_END-2011]),3,0)
        , [NC_END-2012]   =  STR(MAX([NC_END-2012]),12,0)
        , [PC_END-2012]   =  STR(MAX([PC_END-2012]),3,0)
FROM
(
/*** AggrEgate view by C/Y/Q/A *********************************************************************************************************************************/
SELECT
       [YCNT]     = 'NC_' + [YEAR]
      ,[YPCT]     = 'PC_' + [YEAR]
      ,[Variable]
      ,[Value]
      ,Number     = SUM([CntWg])
      ,Percentage = SUM([PctWg])
  FROM
/***************************************************************************************************************************************************************/
(
/*** >>> recode for total events (only GRI_19 is currently working) ********************************************************************************************/
/***************************************************************************************************************************************************************/
SELECT 
       [YEAR]
      ,[Variable]
      ,[Value]
               = CASE
                 WHEN [Variable] = 'GRI_19_x'
                  AND [Value]    > 0
                 THEN              0
                 WHEN [Variable] = 'GRI_19_x'
                  AND [Value]    = 0
                 THEN              NULL
                 WHEN [Variable] = 'SHI_01_x'
                  AND [Value]    > 0
                 THEN              0
                 WHEN [Variable] = 'SHI_01_x'
                  AND [Value]    = 0
                 THEN              NULL
                 WHEN [Variable] = 'SHI_04_x'
                  AND [Value]    > 0
                 THEN              0
                 WHEN [Variable] = 'SHI_04_x'
                  AND [Value]    = 0
                 THEN              NULL
                 WHEN [Variable] = 'SHI_05_x'
                  AND [Value]    > 0
                 THEN              0
                 WHEN [Variable] = 'SHI_05_x'
                  AND [Value]    = 0
                 THEN              NULL
                 ELSE [Value]
                 END
      ,[PctWg]
               = CASE
                 WHEN [Variable] = 'GRI_19_x'
                 THEN              NULL
                 WHEN [Variable] = 'SHI_01_x'
                 THEN              NULL
                 WHEN [Variable] = 'SHI_04_x'
                 THEN              NULL
                 WHEN [Variable] = 'SHI_05_x'
                 THEN              NULL
                 ELSE [PctWg]
                 END
      ,[CntWg]
               = CASE
                 WHEN [Variable] = 'GRI_19_x'
                 THEN [Value]
                 WHEN [Variable] = 'SHI_01_x'
                 THEN [Value]
                 WHEN [Variable] = 'SHI_04_x'
                 THEN [Value]
                 WHEN [Variable] = 'SHI_05_x'
                 THEN [Value]
                 ELSE [CntWg]
                 END
  FROM 
       [V4_L_by_CYV]
/*** <<< recode for total events *******************************************************************************************************************************/
)                                                                                                                                                      AS    RTE
/***************************************************************************************************************************************************************/
GROUP BY
       [YEAR]
      ,[Variable]
      ,[Value]
/********************************************************************************************************************************* Aggregate view by C/Y/Q/A ***/
)                                                                                                                                                      AS A_CYQA
/*** pivoting percentage ***************************************************************************************************************************************/
PIVOT
 (
     MAX(Percentage)
FOR
     YPCT
in (
        [PC_MID-2007]
      , [PC_MID-2008]
      , [PC_MID-2009]
      , [PC_MID-2010]
      , [PC_END-2011]
      , [PC_END-2012]
/***************************************************************************************************************************************************************/
                         )                                                      /*** end of listing of variables                                             ***/
 )                                                                                                                                                    AS   pivt1
/*************************************************************************************************************************************** pivoting percentage ***/
/*** pivoting counts *******************************************************************************************************************************************/
PIVOT
 (
     MAX(Number)
FOR
     YCNT
in (
        [NC_MID-2007]
      , [NC_MID-2008]
      , [NC_MID-2009]
      , [NC_MID-2010]
      , [NC_END-2011]
      , [NC_END-2012]
/***************************************************************************************************************************************************************/
                         )                                                      /*** end of listing of variables                                             ***/
 )                                                                                                                                                    AS   pivt2
/******************************************************************************************************************************************* pivoting counts ***/

GROUP BY
          Variable
        , Value
