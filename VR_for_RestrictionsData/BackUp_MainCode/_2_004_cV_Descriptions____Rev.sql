/***************************************************************************************************************************************************************/
Print '--- '+CONVERT(VARCHAR(19),SYSDATETIME())+' ==>  script 2.004    ---------------------------------------------------------------------------------------- '
/***************************************************************************************************************************************************************/
/***                                                                                                                                            ***/
/***     >>>>>   This is the script used to create the view [GRSHRYYYY].[dbo].[v04_Descriptions]                                      <<<<<     ***/
/***             (descriptions provided current year & descriptions enetered the former coding year - in wide format by country)                ***/
/***                                                                                                                                            ***/
/**************************************************************************************************************************************************/
/*                                                                                                                                                */
USE              [GRSHRcode]
GO
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
IF OBJECT_ID  ('tempdb..#WRK')                        IS NOT NULL
DROP TABLE              #WRK
          SELECT * INTO #WRK
FROM
/**************************************************************************************************************************************************/
      (   SELECT  [X] = CAST([Q_Number] AS VARCHAR(MAX))
                , [Q] =      [QAS]
            FROM  [AT_Qs]
           WHERE             [QAS]     LIKE '%_DES'
                         AND [QAS] NOT LIKE '%_yBe_DES'     )  XTRCT
/**************************************************************************************************************************************************/
declare @CURR nvarchar(4)                                      /***     declare variable for storing current year (number as text)                ***/
set     @CURR = (SELECT MAX([Question_Year]) FROM [GRSH_C])                 /***        set value to current year from main view used as source                                             ***/
declare @PAST nvarchar(4)                                 /***        declare variable for storing former year (number as text)                 ***/
set     @PAST = (SELECT MIN([Question_Year]) FROM [GRSH_C])                 /***        set value to former year from main view used as source                                             ***/

declare @CODEmain nvarchar(max)                           /***        declare variable for storing the main code to be executed                 ***/
set     @CODEmain =                                       /***        start storing text as part of the main code to be executed                ***/
/*********************************************************     >>>>>> this is the main code to be executed                                      ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is the first part w/temp. set known as common table expression CTE   ***/
N'
ALTER VIEW     [v04_Descriptions]
AS

  SELECT EV.[Nation_fk]
        ,EV.[Ctry_EditorialName]
        '
/*********************************************************     <<<<<  this has been the first part of the code                                  ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is the second part of the code to be executed                        ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
+      (  SELECT                                          /*** >      Begin selection (into text, in a cell, comma delimited list)              ***/
                  ',' + [Q] + '_' +  @CURR + '=e' + [X]   /***        condition: no data for current year                                       ***/
                + ',' + [Q] + '_' +  @PAST + '=p' + [X]
                        FROM        [#WRK]                               /***        from table including var names & classifications as rows                  ***/
                                           FOR XML PATH('')  )     /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<<  this has been the second part of the code                                 ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is the third part of the code to be executed                         ***/
+ N'
    FROM
   '
/**************************************************************************************************************************************************/
+ N'
          ( SELECT
                     [Nation_fk]
                    ,[Ctry_EditorialName]
                    ' +
/**************************************************************************************************************************************************/
             ( SELECT ',e' + [X] + ' = ' + [Q] FROM [#WRK]           /*** >      Begin selection (into text, in a cell, comma delimited list of varnames)     ***/
                                           FOR XML PATH('')  )     /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/**************************************************************************************************************************************************/
+ N'
              FROM   [v01_EnteredValues]                              )  EV
   '                                                                          /**/
/**************************************************************************************************************************************************/
+ N'
    INNER JOIN
   '
/**************************************************************************************************************************************************/
+ N'
          ( SELECT
                     [Nation_fk]
                    ,[Ctry_EditorialName]
                    ' +
/**************************************************************************************************************************************************/
             ( SELECT ',p' + [X] + ' = ' + [Q] FROM [#WRK]           /*** >      Begin selection (into text, in a cell, comma delimited list of varnames)     ***/
                                           FOR XML PATH('')  )     /*** <      End of the selection, nesting all cells into an XML string cell              ***/
/**************************************************************************************************************************************************/
+ N'
              FROM   [GRSH_C]
             WHERE   [Question_Year] = ( SELECT MIN([Question_Year])
                                           FROM     [GRSH_C]         ) )  PV
   '


/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
+ N'
    ON      EV.[Nation_fk]
          = PV.[Nation_fk]
      AND   EV.[Ctry_EditorialName]
          = PV.[Ctry_EditorialName]
   '                                                         /*** <<<<<  this completes the seventh and final part of the code                     ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< this is the main code to be executed                                      ***/



/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< this is the main code to be executed                                      ***/
/**************************************************************************************************************************************************/
--	EXEC dbo.LongPrint @CODEmain                          /***        display the currently stored code (to be executed)                        ***/
	EXEC              (@CODEmain)                         /***        execute the code that has been stored as text                             ***/
/**************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/
Print                    '------------------------------------------------------------------------------------------------------------------------------------- '
/***************************************************************************************************************************************************************/
GO