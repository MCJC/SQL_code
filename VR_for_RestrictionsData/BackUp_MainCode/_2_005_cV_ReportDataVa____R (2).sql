/**************************************************************************************************************************************************/
/***                                                                                                                                            ***/
/***     >>>>>   This is the script used to create the view [GRSHRYYYY].[dbo].[v05_ReportData]                                        <<<<<     ***/
/***             (values and descriptions for current & former coding years - in long format by country & variable)                             ***/
/***                                                                                                                                            ***/
/**************************************************************************************************************************************************/
/*                                                                                                                                                */
/*  REFERENCE to 2015 appears JUST ONCE in the script                                                                                             */
/*                                                                                                                                                */
/**************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==> creating view [v05_ReportData]                                                           --- '
/**************************************************************************************************************************************************/
USE              [GRSHRcode]
GO
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> these are the variables to be used                                        ***/
/**************************************************************************************************************************************************/
declare @CURR nvarchar(4)                                 /***        declare variable for storing current year (as text)                       ***/
set     @CURR=(SELECT MAX([Question_Year]) FROM [GRSH_C]) /***        set text value to current year from last-2-yr-datam table                  ***/
declare @PAST nvarchar(4)                                 /***        declare variable for storing former year (as text)                        ***/
set     @PAST=(SELECT MIN([Question_Year]) FROM [GRSH_C]) /***        set text value to current year from last-2-yr-datam table                  ***/

declare @LSTC nvarchar(MAX)                                 /***        declare variable for storing current year (as text)                ***/
set     @LSTC=
(select
STUFF( (                                              /*** >>     stuff function & parenthesis for query XML cell to be stuffed             ***/
          SELECT                                          /*** >      Begin selection (into text, in a cell, comma delimited list)          ***/
                    ', ' + [QAS]                      /***        comma delimiter concatenated to field QA (as varname)            ***/
            FROM      [AT_Qs]                              /***        from table including var names & classifications as rows             ***/


           WHERE (    [Question_fk] IS NOT NULL            /***        include Q with coded, count & perxi answers                            ***/
                  AND  [QAS]        NOT LIKE '%_x'   /***        and include Q with num answers to complete previous Q  */
                  AND  [QAS]        NOT LIKE 'SHI_01_summary_b'      /*       ***/
                  AND [QClass]      NOT IN  ('COUNT')        /***        exclude descriptions                                              ***/
                  AND [QClass]      NOT IN  ('DESCR')  )      /***        exclude descriptions                                              ***/
              OR      [QAS]             LIKE 'SHI_0[4,5]_d_x_[1,2]'   /***        and include Q with num answers to complete previous Q        ***/
             FOR      XML PATH('')                             /*** <      End of selection, nesting all cells into an XML string cell         ***/
                                                               ),1, 1,'') ) /*** <<     stuff from position 1, change 1st comma into ''        ***/


declare @LSTD nvarchar(MAX)                                 /***        declare variable for storing current year (as text)                ***/
set     @LSTD=
(select
STUFF( (                                              /*** >>     stuff function & parenthesis for query XML cell to be stuffed             ***/
          SELECT                                          /*** >      Begin selection (into text, in a cell, comma delimited list)          ***/
                    ', ' + [QAS]                      /***        comma delimiter concatenated to field QA (as varname)            ***/
            FROM      [AT_Qs]                              /***        from table including var names & classifications as rows             ***/
           WHERE (    [Question_fk] IS NOT NULL            /***  excludes GRI_01_yBe_DES, GRI_02_yBe_DES & SHI_04_filter_DES          ***/
                  AND [QClass]          IN ('DESCR')  )      /***        exclude descriptions                                              ***/
             FOR      XML PATH('')                             /*** <      End of selection, nesting all cells into an XML string cell         ***/
                                                               ),1, 1,'') ) /*** <<     stuff from position 1, change 1st comma into ''        ***/




/**************************************************************************************************************************************************/
declare @CODEmain nvarchar(max)                           /***        declare variable for storing the main code to be executed                 ***/
set     @CODEmain =                                       /***        start storing text as part of the main code to be executed                ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< these have been the variables to be used                                  ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> this is the code to be executed                                           ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 1 of the code: main select statement                         ***/
/**************************************************************************************************************************************************/
N'
ALTER VIEW     [v05_ReportData]
AS

SELECT 
       C.[Nation_fk]
      ,C.[Ctry_EditorialName]
      ,C.[Variable]
      ,C.[Change]
      ,C.[Value' + @CURR + ']
      ,C.[Value' + @PAST + ']
      ,C.[DecodedValue_' + @CURR + ']
      ,C.[DecodedValue_' + @PAST + ']
      , D.[Descr_' + @CURR + '] 
      , D.[Descr_' + @PAST + '] 

FROM 


(


SELECT 
       [Nation_fk]
      ,[Ctry_EditorialName]
      ,[Variable]
      ,[Change]              =   [Value' + @CURR + ']
                               - [Value' + @PAST + ']
      ,[Value' + @CURR + ']
      ,[Value' + @PAST + ']
      ,[DecodedValue_' + @CURR + '] = [' + @CURR + ']
      ,[DecodedValue_' + @PAST + '] = [' + @PAST + ']

  FROM
       (
         SELECT
          *
        , [Value' + @CURR + '] = CAST(LEFT([' + @CURR + '],4) AS NUMERIC(38,2)) 
        , [Value' + @PAST + '] = CAST(LEFT([' + @PAST + '],4) AS NUMERIC(38,2)) 


from(

  SELECT
          [Nation_fk]
         ,[Ctry_EditorialName]
         ,[Question_Year]
         ,[Variable]
         ,[Value]
     FROM
         ( SELECT * FROM [v02_AllCodedValues]  )  [YrVals]
          unpivot (      [Value]
                    for  [Variable]
                     in ( ' + @LSTC + ' )                                                          ) AS LongVals
) nnahys

pivot
(
  MAX(Value)
  for [Question_Year] in ([' + @PAST + '], [' + @CURR + '])
) piv

) ReportData

) C


LEFT JOIN


(
         SELECT
          [Nation_fk]
        , [Variable]
        , [Descr_' + @CURR + '] = [' + @CURR + '] 
        , [Descr_' + @PAST + '] = [' + @PAST + '] 


from(

  SELECT
          [Nation_fk]
         ,[Ctry_EditorialName]
         ,[Question_Year]
         ,[Variable]            = REPLACE ([Variable], ''_DES'' , '''' ) 
         ,[Value]
     FROM
         ( SELECT * FROM [v02_AllCodedValues]  )  [YrVals]
          unpivot (      [Value]
                    for  [Variable]
                     in ( ' + @LSTD + ' )                                                          ) AS LongVals
) nnahys

pivot
(
  MAX(Value)
  for [Question_Year] in ([' + @PAST + '], [' + @CURR + '])
) piv
) D


ON 
       C.[Nation_fk]
     = D.[Nation_fk]
 AND
       C.[Variable]
     = D.[Variable]

'

/**************************************************************************************************************************************************/
/*********************************************************     >>>>>> statements to display/execute code stored in the variable @CODEmain       ***/
/**************************************************************************************************************************************************/
--	EXEC dbo.LongPrint @CODEmain                          /***        display the currently stored code (to be executed)                        ***/
	EXEC              (@CODEmain)                         /***        execute the code that has been stored as text                             ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< statements to display/execute code stored in the variable @CODEmain       ***/
/**************************************************************************************************************************************************/
GO



/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 1 of the code: main select statement                   ***/
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 2 of the code: select data of last year & added vars         ***/
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 2 of the code: select data of last year & added vars   ***/
/**************************************************************************************************************************************************/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>>  this is part 3 of the code: select data of current year                   ***/
/**************************************************************************************************************************************************/
/*********************************************************     >>>>   this is part 3.1.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.1.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.1.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.1.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.1 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.2 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.2.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.2.3 of the code                                            ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     >>>>   this is part 3.3 of the code                                              ***/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------------------------------*/
/*********************************************************     <<<<   this is part 3.3 of the code                                              ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<  this has been part 3 of the code: select data of current year             ***/
/**************************************************************************************************************************************************/
/*********************************************************     <<<<<< this has been the code to be executed                                     ***/
/**************************************************************************************************************************************************/
