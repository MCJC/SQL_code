/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the master script to run all scripts for re-creating views and tables related to GRSHR                                    <<<<<     ***/
/***                                                                                                                                                         ***/
/***        NOTICE:                                                                                                                                          ***/
/***                All tables are created from their corresponding BASE-VIEW                                                                                ***/
/***                                                                                                                                                         ***/
/***                -->  Views are AUTOMATICALLY UPDATED in terms of VALUES, when there is no change in structure                                            ***/
/***                                                                                                                                                         ***/
/***                -->  Views SHOULD BE MANUALLY UPDATED if there is any change in structure (adding/removing field(s), etc.)                               ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***             NOTICE:                                                                                                                                     ***/
/***                     This is a SQLCMD script which requires SQLCMD scripting mode to be enabled (from the toolbar icon or the Query menu)                ***/
/***                     Once SQLCMD scripting mode is enabled check that actual SQL scripts listed in folder are coinsistent to current list                ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/***  This code (once SQLCMD scripting mode is enabled) lists scripts in folder (to check if they are coinsistent to the list of scripts)                    ***/
--	  !!dir /B /O "S:\Forum\Database\MANAGEMENT\SQL_code\VR_for_RestrictionsData"
/***************************************************************************************************************************************************************/
USE  [forum_ResAnal]
GO
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/* quick check to determine whether SQLCMD mode is on (and terminate the script if not):                                                                       */
         :setvar DatabaseName "MyDatabase"
         GO
         IF ('$(DatabaseName)' = '$' + '(DatabaseName)')
            RAISERROR ('This script must be run in SQLCMD mode.', 20, 1) WITH LOG
         GO
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
Print  '==> '
Print  '==> '
Print  '    ' + CONVERT (VARCHAR(19), SYSDATETIME()) + '    =====>    SQLCMD mode is  <ON>     start running all code                                       --- '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     SECTION 1: RE-CREATE ALL TABLES FROM THE AUTOMATICALLY UPDATED VIEWS                                                                                ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
Print  '==> '
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  RE-CREATE ALL TABLES from views    ------------------------------------------------------------- '
Print  '==> '
/***=========================================================================================================================================================***/   
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 001    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___00a____NationLocalityTOOL]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___00a____NationLocalityTOOL]
            FROM                 [dbo].[vr___00a]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 002    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___00b____QuestnReligionTOOL]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___00b____QuestnReligionTOOL]
            FROM                 [dbo].[vr___00b]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 003    ---------------------------------------------------------------------------------- '
  DECLARE @CrDt    varchar( 8)
  SET     @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
EXEC ( '  INSERT INTO   [forum_ResAnal].[dbo].[vr___00x____Long__NoAgg___BkUp]
               SELECT   [BkUp_date]  = ''' + @CrDt + '''
                      , * 	
                 FROM   [forum_ResAnal].[dbo].[vr___01_cDB_Long__NoAggregated]  ' )
DROP TABLE       [forum_ResAnal].[dbo].[vr___01_cDB_Long__NoAggregated]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___01_cDB_Long__NoAggregated]
            FROM                 [dbo].[vr___01_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 004    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___02_cDB_Wide__by_Ctry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___02_cDB_Wide__by_Ctry&Year]
            FROM                 [dbo].[vr___02_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 005    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___03_cDB_W&Xtra_byCtry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___03_cDB_W&Xtra_byCtry&Year]
            FROM                 [dbo].[vr___03_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 006    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___04_cDB_SemiWide_byCtry&Yr]
SELECT *    INTO [forum_ResAnal].[dbo].[vr___04_cDB_SemiWide_byCtry&Yr]
            FROM                 [dbo].[vr___04_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 007    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___04v_labSemiWide_byCtry&Yr]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___04v_labSemiWide_byCtry&Yr]
            FROM                 [dbo].[vr___04v]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 008    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vrp__01_cDB_SelDataBYCtry&Year]
            FROM                 [dbo].[vrp__01_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 009    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vrp__01v_labSelDataBYCtry&Year]
SELECT * INTO    [forum_ResAnal].[dbo].[vrp__01v_labSelDataBYCtry&Year]
            FROM                 [dbo].[vrp__01v]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 010    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___05_cDB_Index_byCtryReg&Yr]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___05_cDB_Index_byCtryReg&Yr]
            FROM                 [dbo].[vr___05_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 011    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___06_cDB_LongData_ALL_byCYQ]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___06_cDB_LongData_ALL_byCYQ]
            FROM                 [dbo].[vr___06_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 012    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___07_cDB_MainLongData_byCYQ]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___07_cDB_MainLongData_byCYQ]
            FROM                 [dbo].[vr___07_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 013    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___08_cDB_Weights_f_TopLines]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___08_cDB_Weights_f_TopLines]
            FROM                 [dbo].[vr___08_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 014    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___09_cDB_Basic_TopLines_All]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___09_cDB_Basic_TopLines_All]
            FROM                 [dbo].[vr___09_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 015    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___10_cDB_Published_TopLines]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___10_cDB_Published_TopLines]
            FROM                 [dbo].[vr___10_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 016    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___11_cDB_RHIndexScore_byReg]
SELECT * INTO    [forum_ResAnal].[dbo].[vr___11_cDB_RHIndexScore_byReg]
            FROM                 [dbo].[vr___11_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/   
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 017    ---------------------------------------------------------------------------------- '
DROP TABLE       [forum_ResAnal].[dbo].[vr___12_cDB_Results_by_Country]
SELECT * 	INTO [forum_ResAnal].[dbo].[vr___12_cDB_Results_by_Country]
            FROM                 [dbo].[vr___12_]
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
/***=========================================================================================================================================================***/   
Print  '==> '
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  17 tables in [forum_ResAnal] have been updated from views    ----------------------------------- '
Print  '==> '
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     SECTION 2: ALTER ALL VIEWS & RE-CREATE CORRESPONDING TABLES  (if structure of views should be updated)                                              ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
--	Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  ALTER ALL VIEWS & RE-CREATE ALL TABLES  !!!'
/***************************************************************************************************************************************************************/
/*    --> store working directory (path) in a variable & execute scripts:                                                                                      */
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
----	:setvar path "S:\Forum\Database\MANAGEMENT\SQL_code\VR_for_RestrictionsData"
----       :r  $(path)\_001_lt__NatLocTOOL_____R.sql
----       :r  $(path)\_002_lt__QstRelTOOL_____R.sql
----       :r  $(path)\_003_lt__DBLongNoAggr___R.sql
----       :r  $(path)\_004_lt__DBWide_byCnY___R.sql
----       :r  $(path)\_005_lt__DBWnXt_byCnY___R.sql
----       :r  $(path)\_006_lt__DBSemiW_byCY___R.sql
----       :r  $(path)\_007_lt__DBSemiW_VLab___R.sql
----       :r  $(path)\_008_lt__PubSelVarDat___R.sql
----       :r  $(path)\_009_lt__PubSelVarLab___R.sql
----       :r  $(path)\_010_lt__DBIndexbyCRY___R.sql
----       :r  $(path)\_011_lt__LongData_ALL___R.sql
----       :r  $(path)\_012_lt__LD_forRTeam____R.sql
----       :r  $(path)\_013_lt__weighted_LD____R.sql
----/*     :r  $(path)\_014_lt__BTopLines_W____R.sql  */
----       :r  $(path)\_015_lt__PubTopLines____R.sql
----       :r  $(path)\_016_lt__IdxScoreReg____R.sql
----       :r  $(path)\_017_lt__PRes_byCtry____R.sql
/***************************************************************************************************************************************************************/
--	Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  ALL VIEWS have been ALTERED  &  ALL TABLES have been RE-CREATED !!!'
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     SECTION 3: UPDATE STATA DATASETS                                                                                                                    ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
Print  '==> '
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  UPDATING DATA stored at the LONG FORMAT WORKING dataset    ------------------------------------- '
!!cd c:\do  &  \\PewResearch.net\Stata12\StataSE-64.exe  /e do "C:\do\LW_GRSHR.do"
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ---  dataset has been updated!    ------------------------------------------------------------------- '
Print  '==> '
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
Print  '==> '
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  UPDATING DATA stored at the WIDE FORMAT WORKING dataset    ------------------------------------- '
!!cd c:\do  &  \\PewResearch.net\Stata12\StataSE-64.exe  /e do "C:\do\WW_GRSHR.do"
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ---  dataset has been updated!    ------------------------------------------------------------------- '
Print  '==> '
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
Print  '==> '
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  UPDATING DATA stored at the WIDE FORMAT PUBLIC dataset    -------------------------------------- '
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
!!cd c:\do  &  \\PewResearch.net\Stata12\StataSE-64.exe  /e do "C:\do\WP_GRSHR.do"
Print   '--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ---  dataset has been updated!    ------------------------------------------------------------------- '
Print  '==> '
/*** ------------------------------------------------------------------------------------------------------------------------------------------------------- ***/
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
Print  '==> '
Print  '==> '
Print  '==> '
Print  '==> '
Print  '    ' + CONVERT (VARCHAR(19), SYSDATETIME()) + '    =====>    code from this script has finished running succesfully!                               --- '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
