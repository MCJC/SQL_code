/**************************************************************************************************************************/
/***     >>>>>      This is the main script to run all scripts for updating [forum] to store  Survey Q&A      <<<<<     ***/
/**************************************************************************************************************************/
/***                                                                                                                    ***/
/***     NOTICE:                                                                                                        ***/
/***             This is a SQLCMD script which requires SQLCMD scripting mode to be enabled                             ***/
/***             (from the toolbar icon or the Query menu)                                                              ***/
/***                                                                                                                    ***/
/***                                                                                                                    ***/
/**************************************************************************************************************************/
/**************************************************************************************************************************/
USE [forum]
GO
/*------------------------------------------------------------------------------------------------------------------------*/
/**************************************************************************************************************************/


/**************************************************************************************************************************/
/*****                                                    STEP 001                                                    *****/
/**************************************************************************************************************************/
/*** Once enabled SQLCMD scripting mode, check that actual SQL scripts listed in folder are coinsistent to this script  ***/
/*** This code lists scripts in folder (to check if they are coinsistent to the script):                                ***/
--	  !!dir/B /O "S:\Forum\Database\MANAGEMENT\common\ForumResAnal_&_Intridea\VS_for_SurveyData" 
/**************************************************************************************************************************/


/**************************************************************************************************************************/
/*****                                                    STEP 002                                                    *****/
/**************************************************************************************************************************/
/*** We then check if all tables and views are properly working, before recreating anything!!!                          ***/
/*** this query verifies everything is currently working by retreiving the selection of counts (stored in a view):      ***/
--	pendSELECT * FROM [forum_ResAnal].[dbo].[vi_xCountRows_of_AllViews]
/**************************************************************************************************************************/


/**************************************************************************************************************************/
/*****                                                    STEP 003                                                    *****/
/**************************************************************************************************************************/
/*     We will store beginning and ending times of the whole procedure                                                    */
/**************************************************************************************************************************/
/*------------------------------------------------------------------------------------------------------------------------*/
  IF OBJECT_ID('tempdb..[#BET]') IS NOT NULL
  DROP TABLE            [#BET]
/*------------------------------------------------------------------------------------------------------------------------*/
  DECLARE @CrDt1   varchar(20)                                                 /* declare variable to store current date  */
  SET     @CrDt1 = CONVERT(VARCHAR(20), GETDATE(), 120)                        /* store date in format YYYYMMDD_hhmmss    */
/*------------------------------------------------------------------------------------------------------------------------*/
     SELECT 
	        [K] = 'BeginningTime'
	       ,[T] = @CrDt1
       INTO [#BET]
/*------------------------------------------------------------------------------------------------------------------------*/
--	PRINT   @CrDt
--	        :setvar vers "20150206"
--	PRINT         $(vers)
/*------------------------------------------------------------------------------------------------------------------------*/
/**************************************************************************************************************************/
GO


/**************************************************************************************************************************/
/*****                                                    STEP 004                                                    *****/
/**************************************************************************************************************************/
/*     We now execute the scripts from SQLCMD scripting mode                                                              */
/*------------------------------------------------------------------------------------------------------------------------*/
/*     1  store working directory (path were scripts can be found) in a variable:                                         */
/*------------------------------------------------------------------------------------------------------------------------*/
          :setvar path "S:\Forum\Database\MANAGEMENT\common\ForumResAnal_&_Intridea\VS_for_SurveyData"
/*------------------------------------------------------------------------------------------------------------------------*/
/*     2  execute each script in sequence:                                                                                */
/*        (list can be updated from the files listed for the directory)                                                   */
/*------------------------------------------------------------------------------------------------------------------------*/
	   --:r  $(path)\S0__vd01__vd___DB______________________.sql
	   --:r  $(path)\svy1_Chg__PAnswer_Std______from_xlsxSet_20150206.sql
	   --:r  $(path)\svy2_Chg__PQuestion_Std____from_xlsxSet_20150206.sql
	   --:r  $(path)\svy3_Chg__PQuestion_NoStd__from_xlsxSet_20150206.sql
	   --:r  $(path)\svy4_Chg__PAnswer_NoStd____from_xlsxSet_20150206.sql
	   :r  $(path)\svy5_Chg__PQuestion_Topic__from_xlsxSet_20150206.sql

/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
-- TEST
--	   :r  $(path)\create_vi99_vi_xCountRows_of_AllViews.sql
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
-- Actual code to check, after SQLCMD has finished, is:
--	SELECT * FROM [forum_ResAnal].[dbo].[vi_xCountRows_of_AllViews]  -- this used to be the selection of counts, now in a view


/**************************************************************************************************************************/
/*****                                                    STEP 006                                                    *****/
/**************************************************************************************************************************/
/*     Display time frame, after storing ending time of the whole procedure                                               */
/**************************************************************************************************************************/
/*------------------------------------------------------------------------------------------------------------------------*/
  DECLARE @CrDt2   varchar(20)                                                 /* declare variable to store current date  */
  SET     @CrDt2 = CONVERT(VARCHAR(20), GETDATE(), 120)                        /* store date in format YYYYMMDD_hhmmss    */
/*------------------------------------------------------------------------------------------------------------------------*/
INSERT INTO [#BET]
     SELECT 
	        [K] = 'BeginningTime'
	       ,[T] = @CrDt2
/*------------------------------------------------------------------------------------------------------------------------*/
     SELECT * 
       FROM [#BET]
/*------------------------------------------------------------------------------------------------------------------------*/
/**************************************************************************************************************************/
GO
